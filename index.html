<!DOCTYPE html>
<html lang="th" data-theme="light">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>CytoFlow 2026</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <?!= include('css'); ?>
</head>
<body class="antialiased h-screen overflow-hidden flex flex-col" @click="closeAllDropdowns">
  
  <div id="app" v-cloak class="w-full h-full relative">

    <!-- Loading Overlay -->
    <transition name="fade">
        <div v-if="isLoading" class="fixed inset-0 z-[9999] bg-black/40 backdrop-blur-md flex items-center justify-center">
            <div class="liquid-glass p-8 rounded-[2rem] flex flex-col items-center animate-pulse">
                <i class="ph ph-spinner-gap animate-spin text-5xl text-indigo-500 mb-4"></i>
                <span class="theme-text font-bold tracking-wide">Processing...</span>
            </div>
        </div>
    </transition>

    <!-- LOCK SCREEN OVERLAY -->
    <transition name="screen-lock">
        <div v-if="isLocked && page !== 'login'" class="fixed inset-0 z-[90] bg-slate-900/90 backdrop-blur-xl flex flex-col items-center justify-center p-6 text-white text-center">
            <div class="w-24 h-24 mb-6 rounded-full overflow-hidden border-4 border-slate-700 shadow-2xl">
                <img :src="user.image || 'https://via.placeholder.com/150?text=U'" class="w-full h-full object-cover">
            </div>
            <h2 class="text-3xl font-black mb-2">{{ user.name }}</h2>
            <p class="text-slate-400 mb-8 font-medium">เข้าสู่โหมดพักหน้าจอ (Locked)</p>
            
            <form @submit.prevent="unlockScreen" class="w-full max-w-sm flex flex-col gap-4">
                <div class="relative">
                    <i class="ph ph-lock-key absolute left-4 top-3.5 text-slate-400 text-lg"></i>
                    <input v-model="lockPassword" type="password" class="w-full pl-12 pr-4 py-3 bg-slate-800/80 border border-slate-600 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none text-white text-center tracking-widest" placeholder="Enter Password to Unlock" required>
                </div>
                <p v-if="lockError" class="text-rose-400 text-sm font-bold">{{ lockError }}</p>
                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3.5 rounded-xl transition shadow-lg">Unlock Screen</button>
                <button type="button" @click="handleLogout" class="mt-4 text-slate-400 hover:text-white text-sm font-medium transition">Not {{ user.name }}? Sign out</button>
            </form>
        </div>
    </transition>

    <!-- Settings Modal -->
    <transition name="fade">
        <div v-if="showSettingsModal" @click.self="showSettingsModal=false" class="fixed inset-0 z-[60] bg-slate-900/40 backdrop-blur-sm flex items-center justify-center p-4">
            <div class="liquid-glass rounded-3xl w-full max-w-sm p-0 overflow-hidden animate-slide-up">
                <div class="p-5 border-b theme-border flex justify-between items-center">
                    <h3 class="text-lg font-bold theme-text flex items-center gap-2"><i class="ph ph-gear-six text-xl text-indigo-500"></i> ตั้งค่าระบบ</h3>
                    <button @click="showSettingsModal=false" class="text-slate-400 hover:text-rose-500 text-2xl font-bold transition">&times;</button>
                </div>
                <div class="p-6 border-b theme-border text-center">
                    <div class="w-20 h-20 mx-auto mb-3 bg-white/80 rounded-2xl p-2 shadow-sm"><img :src="systemConfig.logoUrl" class="w-full h-full object-contain blend-logo"></div>
                    <h2 class="font-black text-2xl animated-pastel-text">CytoFlow</h2>
                    <span class="text-[10px] text-white bg-indigo-600 font-bold px-2 py-0.5 rounded-md mt-1 inline-block shadow-sm">v{{ appVersion }}</span>
                </div>
                <div class="p-6 space-y-5">
                    <div>
                        <h4 class="text-[11px] font-bold theme-text-muted uppercase tracking-widest mb-3">ธีมสี (Theme)</h4>
                        <div class="grid grid-cols-3 gap-2">
                            <button @click="changeTheme('light')" :class="['p-2 rounded-xl flex flex-col items-center gap-1 transition', theme === 'light' ? 'bg-indigo-100 text-indigo-600 border border-indigo-200' : 'bg-slate-100 text-slate-500 border border-transparent hover:bg-slate-200']"><i class="ph ph-sun text-xl"></i><span class="text-[10px] font-bold">สว่าง</span></button>
                            <button @click="changeTheme('eyecare')" :class="['p-2 rounded-xl flex flex-col items-center gap-1 transition', theme === 'eyecare' ? 'bg-amber-100 text-amber-700 border border-amber-200' : 'bg-slate-100 text-slate-500 border border-transparent hover:bg-amber-50']"><i class="ph ph-eye text-xl"></i><span class="text-[10px] font-bold">ถนอมสายตา</span></button>
                            <button @click="changeTheme('dark')" :class="['p-2 rounded-xl flex flex-col items-center gap-1 transition', theme === 'dark' ? 'bg-slate-700 text-white border border-slate-600' : 'bg-slate-100 text-slate-500 border border-transparent hover:bg-slate-200']"><i class="ph ph-moon text-xl"></i><span class="text-[10px] font-bold">มืด</span></button>
                        </div>
                    </div>
                    
                    <div>
                        <h4 class="text-[11px] font-bold theme-text-muted uppercase tracking-widest mb-3">บัญชีผู้ใช้</h4>
                        <button @click="openChangePassword" class="w-full bg-[var(--bg-input)] hover:brightness-95 border theme-border rounded-2xl p-4 flex justify-between items-center shadow-sm active:scale-95 transition group">
                            <div class="flex items-center gap-3">
                                <div class="bg-orange-100 p-2.5 rounded-xl text-orange-500 group-hover:bg-orange-500 group-hover:text-white transition-colors duration-300"><i class="ph ph-key text-lg"></i></div>
                                <div class="text-left"><span class="font-bold theme-text block">เปลี่ยนรหัสผ่าน</span><span class="text-[11px] theme-text-muted">แก้ไขรหัสผ่านส่วนตัว</span></div>
                            </div>
                            <i class="ph ph-caret-right text-slate-400 group-hover:translate-x-1 transition-transform"></i>
                        </button>
                    </div>
                    <div v-if="user.role === 'Admin'">
                        <h4 class="text-[11px] font-bold theme-text-muted uppercase tracking-widest mb-3">ระบบ (Admin)</h4>
                        <label class="w-full bg-[var(--bg-input)] hover:brightness-95 border theme-border rounded-2xl p-4 flex justify-between items-center shadow-sm active:scale-95 transition relative overflow-hidden cursor-pointer block group">
                            <div class="flex items-center gap-3">
                                <div class="bg-purple-100 p-2.5 rounded-xl text-purple-500 group-hover:bg-purple-500 group-hover:text-white transition-colors duration-300"><i class="ph ph-image text-lg"></i></div>
                                <div class="text-left"><span class="font-bold theme-text block">เปลี่ยน Logo ระบบ</span><span class="text-[11px] theme-text-muted">รองรับ GIF/PNG/JPG</span></div>
                            </div>
                            <i class="ph ph-upload-simple text-slate-400 group-hover:-translate-y-1 transition-transform"></i>
                            <input type="file" @change="handleImageUpload($event, 'logo')" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer hidden">
                        </label>
                    </div>
                    <div class="text-center pt-4 border-t theme-border">
                        <p class="text-[10px] theme-text-muted mt-1 font-medium">Developed by<br><span class="gimmick-hover cursor-pointer font-bold mt-1">P. PURICUMPEE</span></p>
                    </div>
                </div>
            </div>
        </div>
    </transition>

    <!-- Profile Modal -->
    <transition name="fade">
        <div v-if="showProfileModal" @click.self="showProfileModal=false" class="fixed inset-0 z-[60] bg-slate-900/40 backdrop-blur-sm flex items-center justify-center p-4">
            <div class="liquid-glass rounded-3xl w-full max-w-sm p-8 shadow-2xl relative animate-slide-up flex flex-col items-center">
                <button @click="showProfileModal=false" class="absolute top-5 right-5 text-slate-400 hover:text-rose-500 text-2xl font-bold transition">&times;</button>
                <label class="relative w-36 h-36 rounded-full border-4 theme-border shadow-xl mb-5 group cursor-pointer overflow-hidden block">
                    <img :src="user.image || 'https://via.placeholder.com/150?text=U'" class="w-full h-full object-cover">
                    <div class="absolute inset-0 bg-black/50 hidden group-hover:flex items-center justify-center text-white font-medium text-sm backdrop-blur-sm transition-all"><i class="ph ph-camera text-xl mb-1 block text-center w-full"></i></div>
                    <input type="file" @change="handleImageUpload($event, 'profile')" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer hidden">
                </label>
                <h3 class="text-2xl font-black theme-text tracking-tight">{{ user.name }}</h3>
                <p class="text-sm text-indigo-700 font-bold bg-indigo-100/80 px-4 py-1.5 rounded-full mt-2 border border-indigo-200">{{ user.position || 'User' }}</p>
                <p class="text-xs theme-text-muted mt-3 font-medium uppercase tracking-widest">Role: <span class="theme-text">{{ user.role }}</span></p>
            </div>
        </div>
    </transition>

    <!-- LOGIN PAGE -->
    <transition name="slide-fade" mode="out-in">
    <div v-if="page === 'login'" class="min-h-screen flex items-center justify-center p-4 bg-deep-space w-full relative overflow-hidden">
        <div class="absolute top-[-10%] left-[-5%] w-[500px] h-[500px] bg-indigo-500/40 rounded-full mix-blend-screen filter blur-[100px] animate-blob"></div>
        <div class="absolute top-[20%] right-[-10%] w-[400px] h-[400px] bg-teal-400/40 rounded-full mix-blend-screen filter blur-[100px] animate-blob animation-delay-2000"></div>
        <div class="absolute bottom-[-15%] left-[25%] w-[600px] h-[600px] bg-pink-500/30 rounded-full mix-blend-screen filter blur-[100px] animate-blob animation-delay-4000"></div>

        <div class="liquid-glass rounded-[2rem] p-10 w-full max-w-md relative z-10 text-center" style="--bg-card: rgba(255, 255, 255, 0.1); border-color: rgba(255,255,255,0.2);">
            <div class="inline-flex items-center justify-center w-28 h-28 mb-4 bg-white/20 rounded-3xl p-3 shadow-inner backdrop-blur-md">
                <img :src="systemConfig.logoUrl" class="w-full h-full object-contain filter drop-shadow-lg blend-logo">
            </div>
            
            <h1 class="text-4xl font-extrabold tracking-tight mb-1 animated-pastel-text">CytoFlow</h1>
            <p class="text-[11px] text-slate-300 uppercase tracking-widest font-semibold mb-8">Cytology Laboratory Management<br>Information System</p>
            
            <form v-if="loginStep === 1" @submit.prevent="handleLoginStep1" class="space-y-5 animate-slide-up text-left">
                <div>
                    <label class="block text-xs font-bold text-slate-300 mb-1.5 ml-1 uppercase tracking-wider">Username</label>
                    <div class="relative">
                        <i class="ph ph-user absolute left-4 top-3.5 text-slate-400 text-lg"></i>
                        <input v-model="formLogin.username" type="text" class="w-full pl-12 pr-4 py-3 bg-white/10 border border-white/20 rounded-xl focus:ring-2 focus:ring-indigo-400 outline-none transition-all text-white font-medium" placeholder="Enter username" required>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-300 mb-1.5 ml-1 uppercase tracking-wider">Password</label>
                    <div class="relative">
                        <i class="ph ph-lock-key absolute left-4 top-3.5 text-slate-400 text-lg"></i>
                        <input v-model="formLogin.password" type="password" class="w-full pl-12 pr-4 py-3 bg-white/10 border border-white/20 rounded-xl focus:ring-2 focus:ring-indigo-400 outline-none transition-all text-white font-medium" placeholder="Enter password" required>
                    </div>
                </div>
                <button type="submit" class="w-full bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 text-white font-bold py-3.5 rounded-xl shadow-[0_10px_20px_rgba(99,102,241,0.3)] transition-all transform hover:-translate-y-0.5 mt-2">Sign In</button>
                
                <div class="text-center pt-8 border-t border-white/10">
                    <p class="text-[11px] text-slate-400 font-medium mb-1">Version {{ appVersion }}</p>
                    <p class="text-[11px] text-slate-400 font-medium mt-2">Developed by<br><span class="gimmick-hover cursor-pointer text-slate-300 font-bold mt-1">P. PURICUMPEE</span></p>
                </div>
            </form>

            <form v-else @submit.prevent="handleLoginStep2" class="space-y-5 animate-slide-up text-left">
                <div class="text-center bg-blue-500/20 border border-blue-400/50 text-blue-100 p-4 rounded-2xl text-sm mb-4 backdrop-blur-sm shadow-sm"><i class="ph ph-envelope-open text-2xl block mb-2 text-blue-400 mx-auto"></i>{{ otpMessage }}</div>
                <div>
                    <label class="block text-xs font-bold text-slate-300 mb-1.5 text-center uppercase tracking-widest">OTP Code</label>
                    <input v-model="otpInput" type="text" maxlength="6" class="w-full text-center tracking-[0.7em] text-3xl font-black py-4 bg-white/10 border-2 border-indigo-400/50 rounded-2xl focus:border-indigo-400 focus:ring-4 focus:ring-indigo-500/20 outline-none text-white transition-all shadow-inner" placeholder="••••••" required>
                </div>
                <button type="submit" class="w-full bg-gradient-to-r from-emerald-400 to-teal-500 hover:from-emerald-500 hover:to-teal-600 text-white font-bold py-4 rounded-2xl shadow-[0_10px_20px_rgba(16,185,129,0.3)] transition-all transform hover:-translate-y-0.5">Verify Identity</button>
                <button type="button" @click="loginStep=1" class="w-full text-slate-400 hover:text-white text-sm font-bold transition-colors mt-2 text-center">← Back to Login</button>
            </form>
        </div>
    </div>

    <!-- MAIN APP LAYOUT -->
    <div v-else class="flex h-screen w-full overflow-hidden">
        
        <!-- Sidebar -->
        <aside :class="['liquid-sidebar shadow-lg flex flex-col shrink-0 z-30 h-full transition-all duration-300 relative', isSidebarOpen ? 'w-[280px]' : 'w-20']">
            <button @click="isSidebarOpen = !isSidebarOpen" class="absolute -right-3.5 top-8 bg-[var(--bg-input)] theme-border border rounded-full w-7 h-7 flex items-center justify-center shadow-md text-slate-400 hover:text-indigo-600 z-40 transition-transform hover:scale-110" :class="!isSidebarOpen ? 'rotate-180' : ''">
                <i class="ph ph-caret-left text-sm font-bold"></i>
            </button>

            <div class="p-4 border-b theme-border flex flex-col items-center gap-2 shrink-0 h-[110px] justify-center overflow-hidden">
                <div class="flex items-center gap-3 w-full justify-center">
                    <div class="w-12 h-12 flex items-center justify-center cursor-pointer hover:scale-110 transition-transform shrink-0" @click="toggleLogo" title="Click to Pause/Play"><img ref="logoRef" :src="systemConfig.logoUrl" class="w-full h-full object-contain blend-logo"></div>
                    <div v-show="isSidebarOpen" class="whitespace-nowrap transition-opacity duration-300 flex flex-col justify-center">
                        <h2 class="font-black text-2xl theme-text tracking-tight leading-none animated-pastel-text">CytoFlow</h2>
                        <span class="text-[9px] text-white bg-indigo-600 font-bold px-1.5 py-0.5 rounded-md self-start mt-1 shadow-sm">v{{ appVersion }}</span>
                    </div>
                </div>
            </div>
            
            <div v-show="isSidebarOpen" class="px-5 py-3 text-[10px] font-bold uppercase tracking-widest theme-text-muted text-center leading-relaxed border-b theme-border whitespace-normal bg-black/5">
                Cytology Laboratory<br>Management System
            </div>
            
            <div class="p-4 border-b theme-border shrink-0 overflow-hidden">
                <div @click="showProfileModal=true" class="flex items-center justify-center md:justify-start gap-3 mb-1 cursor-pointer hover:bg-black/5 p-2 rounded-xl transition-all group">
                    <div class="w-11 h-11 rounded-full bg-slate-100 border-2 theme-border shadow-sm overflow-hidden flex items-center justify-center group-hover:ring-4 ring-indigo-200 transition-all shrink-0">
                        <img v-if="user.image" :src="user.image" class="w-full h-full object-cover">
                        <i v-else class="ph ph-user text-2xl text-slate-400"></i>
                    </div>
                    <div v-show="isSidebarOpen" class="overflow-hidden">
                        <div class="text-[15px] font-bold theme-text truncate">{{ user.name }}</div>
                        <div class="text-[11px] text-indigo-500 font-bold truncate">{{ user.position }}</div>
                    </div>
                </div>
                <div v-show="isSidebarOpen" class="mt-4 px-2">
                    <label class="text-[10px] font-bold theme-text-muted uppercase tracking-widest">ปีงบประมาณ</label>
                    <div class="relative mt-1">
                        <select v-model="config.selectedYear" class="w-full p-2.5 bg-[var(--bg-input)] border theme-border rounded-xl text-sm outline-none focus:border-indigo-400 focus:ring-2 focus:ring-indigo-100 font-bold theme-text appearance-none cursor-pointer transition-all shadow-sm">
                            <option v-for="(y, index) in config.years" :key="'yr-'+index" :value="y">{{ y }}</option>
                        </select>
                        <i class="ph ph-caret-down absolute right-3 top-3 text-slate-400 pointer-events-none"></i>
                    </div>
                </div>
            </div>

            <nav class="flex-1 p-3 space-y-1.5 overflow-y-auto overflow-x-hidden">
                <a href="#" @click.prevent="openRegisterPage" :class="['flex items-center gap-4 px-3 py-3.5 rounded-2xl transition-all group overflow-hidden', page === 'register' ? 'bg-pink-500/10 text-pink-600 shadow-sm border border-pink-500/20' : 'theme-text-muted hover:bg-black/5 hover:theme-text']" :title="!isSidebarOpen ? 'ลงทะเบียน' : ''">
                    <div class="w-8 flex justify-center"><i class="ph ph-user-plus text-2xl group-hover:text-pink-500 group-hover:-translate-y-1 transition-transform"></i></div>
                    <span v-show="isSidebarOpen" class="whitespace-nowrap font-bold text-[15px]">ลงทะเบียน</span>
                </a>
                <a href="#" @click.prevent="page = 'dashboard'" :class="['flex items-center gap-4 px-3 py-3.5 rounded-2xl transition-all group overflow-hidden', page === 'dashboard' ? 'bg-blue-500/10 text-blue-600 shadow-sm border border-blue-500/20' : 'theme-text-muted hover:bg-black/5 hover:theme-text']" :title="!isSidebarOpen ? 'รายการผู้รับบริการ' : ''">
                    <div class="w-8 flex justify-center"><i class="ph ph-users-three text-2xl group-hover:text-blue-500 transition-all"></i></div>
                    <span v-show="isSidebarOpen" class="whitespace-nowrap font-bold text-[15px]">รายการผู้รับบริการ</span>
                </a>
                <a v-if="canAccessReport" href="#" @click.prevent="openReportList" :class="['flex items-center gap-4 px-3 py-3.5 rounded-2xl transition-all group overflow-hidden', ['report_list', 'report_form'].includes(page) ? 'bg-emerald-500/10 text-emerald-600 shadow-sm border border-emerald-500/20' : 'theme-text-muted hover:bg-black/5 hover:theme-text']" :title="!isSidebarOpen ? 'รายงานผล' : ''">
                    <div class="w-8 flex justify-center"><i class="ph ph-file-text text-2xl group-hover:text-emerald-500 transition-transform"></i></div>
                    <span v-show="isSidebarOpen" class="whitespace-nowrap font-bold text-[15px]">รายงานผล</span>
                </a>
                <a href="#" @click.prevent="page = 'statistics'" :class="['flex items-center gap-4 px-3 py-3.5 rounded-2xl transition-all group overflow-hidden', page === 'statistics' ? 'bg-violet-500/10 text-violet-600 shadow-sm border border-violet-500/20' : 'theme-text-muted hover:bg-black/5 hover:theme-text']" :title="!isSidebarOpen ? 'สถิติ' : ''">
                    <div class="w-8 flex justify-center"><i class="ph ph-chart-bar text-2xl group-hover:text-violet-500 transition-transform group-hover:scale-110"></i></div>
                    <span v-show="isSidebarOpen" class="whitespace-nowrap font-bold text-[15px]">สถิติ</span>
                </a>
            </nav>

            <div class="p-3 border-t theme-border shrink-0 flex flex-col gap-1.5">
                <button @click="lockScreen" class="w-full flex items-center justify-center md:justify-start pl-0 md:pl-2 gap-3 theme-text-muted hover:bg-black/5 hover:text-indigo-500 py-3 rounded-2xl transition font-bold text-sm group" :title="!isSidebarOpen ? 'ล็อกหน้าจอ' : ''">
                    <i class="ph ph-lock text-xl group-hover:scale-110 transition-transform"></i>
                    <span v-show="isSidebarOpen">ล็อกหน้าจอ</span>
                </button>
                <button @click="showSettingsModal=true" class="w-full flex items-center justify-center md:justify-start pl-0 md:pl-2 gap-3 theme-text-muted hover:bg-black/5 hover:text-orange-500 py-3 rounded-2xl transition font-bold text-sm group" :title="!isSidebarOpen ? 'ตั้งค่า' : ''">
                    <i class="ph ph-gear-six text-xl group-hover:rotate-90 transition-transform duration-500"></i>
                    <span v-show="isSidebarOpen">ตั้งค่าระบบ</span>
                </button>
                <button @click="handleLogout" class="w-full flex items-center justify-center md:justify-start pl-0 md:pl-2 gap-3 text-rose-500 hover:bg-rose-500/10 py-3 rounded-2xl transition font-bold text-sm group" :title="!isSidebarOpen ? 'ออกจากระบบ' : ''">
                    <i class="ph ph-sign-out text-xl group-hover:-translate-x-1 transition-transform"></i>
                    <span v-show="isSidebarOpen">ออกจากระบบ</span>
                </button>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="flex-1 relative flex flex-col h-full w-full" 
              @scroll="handleMainScroll"
              :class="[
                theme === 'dark' ? 'bg-gradient-to-br from-slate-900 to-slate-800' : (theme === 'eyecare' ? 'bg-gradient-to-br from-[#fbf6ec] to-[#f4ead5]' : 'bg-gradient-to-br from-slate-50 to-[#eef2f6]'),
                ['dashboard', 'report_list', 'statistics'].includes(page) ? 'overflow-hidden' : 'overflow-y-auto custom-scroll'
              ]">
            <div class="p-4 md:p-6 w-full max-w-[1600px] mx-auto flex-1 flex flex-col gap-3 relative z-10" :class="['dashboard', 'report_list', 'statistics'].includes(page) ? 'h-full min-h-0' : ''">
                
                <transition name="slide-fade" mode="out-in">
                
                <!-- NEW Statistics Page -->
                <div v-if="page === 'statistics'" key="statistics" class="flex flex-col gap-4 h-full overflow-hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 liquid-glass p-4 rounded-2xl shrink-0">
                        <div>
                            <h2 class="text-2xl font-black theme-text">ภาพรวมการดำเนินงาน</h2>
                            <p class="theme-text-muted text-sm font-medium">ปีงบประมาณ {{ config.selectedYear }}</p>
                        </div>
                        <div class="flex gap-3">
                            <button @click="isDashboardTopOpen = !isDashboardTopOpen" class="bg-[var(--bg-input)] hover:brightness-95 theme-text w-10 h-10 rounded-xl flex items-center justify-center transition shadow-sm border theme-border">
                                <i class="ph ph-caret-up text-lg transition-transform duration-300" :class="!isDashboardTopOpen ? 'rotate-180' : ''"></i>
                            </button>
                            <button @click="fetchData" class="bg-violet-50 hover:bg-violet-100 text-violet-700 px-4 py-2 rounded-xl shadow-sm transition flex items-center gap-2 text-sm font-bold border border-violet-200">
                                <i class="ph ph-arrows-clockwise text-lg" :class="{'animate-spin': isSpinning}"></i> อัปเดตข้อมูล
                            </button>
                        </div>
                    </div>

                    <div class="flex-1 overflow-y-auto custom-scroll pb-6" @scroll="handleTableScroll">
                        <div v-show="isDashboardTopOpen" class="grid grid-cols-1 lg:grid-cols-12 gap-4 animate-slide-up origin-top mb-4">
                            <div class="lg:col-span-3 flex flex-col gap-3">
                                <div class="liquid-glass p-4 rounded-[1.25rem] relative overflow-hidden group hover:-translate-y-1 transition border-l-4 border-l-blue-500">
                                    <div class="relative z-10"><p class="theme-text-muted text-[11px] font-bold uppercase tracking-widest mb-0">สิ่งส่งตรวจทั้งหมด</p><h3 class="text-3xl leading-none font-black text-blue-500 mt-1">{{ stats.total }}</h3></div>
                                    <i class="ph ph-flask absolute right-4 bottom-3 text-4xl text-blue-500 opacity-20 group-hover:opacity-100 group-hover:scale-110 transition-all"></i>
                                </div>
                                <div class="liquid-glass p-4 rounded-[1.25rem] relative overflow-hidden group hover:-translate-y-1 transition border-l-4 border-l-emerald-500">
                                    <div class="relative z-10"><p class="theme-text-muted text-[11px] font-bold uppercase tracking-widest mb-0">รายงานผลแล้ว</p><h3 class="text-3xl leading-none font-black text-emerald-500 mt-1">{{ stats.reported }}</h3></div>
                                    <i class="ph ph-check-circle absolute right-4 bottom-3 text-4xl text-emerald-500 opacity-20 group-hover:opacity-100 group-hover:scale-110 transition-all"></i>
                                </div>
                                <div class="liquid-glass p-4 rounded-[1.25rem] relative overflow-hidden group hover:-translate-y-1 transition border-l-4 border-l-orange-500">
                                    <div class="relative z-10"><p class="theme-text-muted text-[11px] font-bold uppercase tracking-widest mb-0">รอรายงานผล</p><h3 class="text-3xl leading-none font-black text-orange-500 mt-1">{{ stats.total - stats.reported }}</h3></div>
                                    <i class="ph ph-clock absolute right-4 bottom-3 text-4xl text-orange-500 opacity-20 group-hover:opacity-100 group-hover:scale-110 transition-all"></i>
                                </div>
                            </div>

                            <div class="lg:col-span-4 liquid-glass p-4 rounded-3xl flex flex-col items-center justify-center relative min-h-[200px]">
                                <h3 class="font-bold theme-text text-sm absolute top-4 left-5 w-full flex justify-between pr-10">
                                    <span>ความคืบหน้าภาพรวม</span>
                                    <span class="text-indigo-500">{{ progressPercent }}%</span>
                                </h3>
                                <div class="w-full h-32 mt-4 relative">
                                    <canvas id="statusChart"></canvas>
                                </div>
                                
                                <div class="w-full mt-3 pt-3 border-t theme-border flex justify-between items-center px-2">
                                    <div class="text-center">
                                        <span class="text-[10px] theme-text-muted font-bold block">ในเกณฑ์ TAT ({{tatOverview.percentOnTime}}%)</span>
                                        <span class="text-emerald-500 font-black text-lg">{{ tatOverview.onTime }}</span>
                                    </div>
                                    <div class="flex-1 px-4 flex items-center justify-center">
                                         <div class="w-full bg-slate-200/50 rounded-full h-2 flex overflow-hidden shadow-inner">
                                            <div class="bg-gradient-to-r from-emerald-400 to-emerald-500 h-full" :style="{ width: tatOverview.percentOnTime + '%' }"></div>
                                            <div class="bg-gradient-to-r from-rose-400 to-rose-500 h-full" :style="{ width: (100 - tatOverview.percentOnTime) + '%' }"></div>
                                        </div>
                                    </div>
                                    <div class="text-center">
                                        <span class="text-[10px] theme-text-muted font-bold block">เกินเกณฑ์ ({{100 - tatOverview.percentOnTime}}%)</span>
                                        <span class="text-rose-500 font-black text-lg">{{ tatOverview.late }}</span>
                                    </div>
                                </div>
                            </div>

                            <div class="lg:col-span-5 liquid-glass p-4 rounded-3xl flex flex-col">
                                <h3 class="font-bold theme-text text-sm mb-3">สถานะแบ่งตามหน่วยงาน</h3>
                                <div class="flex-1 overflow-y-auto pr-3 space-y-3 max-h-[220px] custom-scroll">
                                    <div v-for="u in unitStats" :key="u.name" class="w-full">
                                        <div class="flex justify-between items-end mb-1">
                                            <span class="text-[13px] font-bold theme-text truncate max-w-[65%]">{{ u.name }}</span>
                                            <span class="text-xs font-bold theme-text-muted">{{ u.reported }} / {{ u.total }} <span class="text-[10px] opacity-70 font-normal">({{ Math.round((u.reported/u.total)*100) }}%)</span></span>
                                        </div>
                                        <div class="w-full bg-black/5 rounded-full h-1.5 overflow-hidden flex shadow-inner">
                                            <div class="bg-gradient-to-r from-cyan-400 via-blue-500 to-indigo-500 h-full rounded-full transition-all duration-1000 ease-out" :style="{ width: (u.reported/u.total)*100 + '%' }"></div>
                                        </div>
                                    </div>
                                    <div v-if="unitStats.length === 0" class="text-center theme-text-muted text-sm py-10 font-medium">ไม่มีข้อมูลหน่วยงาน</div>
                                </div>
                            </div>
                        </div>

                        <div v-show="!isDashboardTopOpen" class="liquid-glass p-3 rounded-2xl flex flex-wrap gap-4 items-center shrink-0 animate-slide-up mb-4">
                            <div class="flex items-center gap-3 border-r theme-border pr-4"><div class="w-8 h-8 rounded-full bg-blue-500/10 text-blue-500 flex items-center justify-center"><i class="ph ph-flask text-lg"></i></div><div><p class="text-[9px] font-bold theme-text-muted uppercase">ทั้งหมด</p><p class="text-lg font-black theme-text leading-none mt-0.5">{{ stats.total }}</p></div></div>
                            <div class="flex items-center gap-3 border-r theme-border pr-4"><div class="w-8 h-8 rounded-full bg-emerald-500/10 text-emerald-500 flex items-center justify-center"><i class="ph ph-check-circle text-lg"></i></div><div><p class="text-[9px] font-bold theme-text-muted uppercase">รายงานผลแล้ว</p><p class="text-lg font-black text-emerald-500 leading-none mt-0.5">{{ stats.reported }}</p></div></div>
                            <div class="flex items-center gap-3 border-r theme-border pr-4"><div class="w-8 h-8 rounded-full bg-orange-500/10 text-orange-500 flex items-center justify-center"><i class="ph ph-clock text-lg"></i></div><div><p class="text-[9px] font-bold theme-text-muted uppercase">รอผล</p><p class="text-lg font-black text-orange-500 leading-none mt-0.5">{{ stats.total - stats.reported }}</p></div></div>
                            <div class="flex items-center gap-3 pr-4"><div class="w-8 h-8 rounded-full bg-indigo-500/10 text-indigo-500 flex items-center justify-center"><i class="ph ph-clock-countdown text-lg"></i></div><div><p class="text-[9px] font-bold theme-text-muted uppercase">ในเกณฑ์ TAT</p><p class="text-lg font-black text-indigo-500 leading-none mt-0.5">{{ tatOverview.percentOnTime }}%</p></div></div>
                            
                            <div class="ml-auto w-48 hidden md:block">
                                <div class="flex justify-between text-[10px] font-bold theme-text-muted mb-0.5"><span>Progress</span><span>{{ progressPercent }}%</span></div>
                                <div class="w-full bg-black/5 rounded-full h-1.5 overflow-hidden"><div class="bg-gradient-to-r from-indigo-500 to-purple-500 h-full rounded-full" :style="{ width: progressPercent + '%' }"></div></div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 animate-slide-up">
                            <div class="liquid-glass p-6 rounded-3xl min-h-[250px] flex flex-col items-center justify-center text-center opacity-70 border-dashed border-2">
                                <i class="ph ph-chart-pie-slice text-5xl theme-text-muted mb-3 opacity-50"></i>
                                <h3 class="font-bold theme-text">สถิติผลการตรวจ (ทุกหน่วยงาน)</h3>
                                <p class="text-xs theme-text-muted mt-1">ส่วนรองรับการพัฒนาในอนาคต</p>
                            </div>
                            <div class="liquid-glass p-6 rounded-3xl min-h-[250px] flex flex-col items-center justify-center text-center opacity-70 border-dashed border-2">
                                <i class="ph ph-buildings text-5xl theme-text-muted mb-3 opacity-50"></i>
                                <h3 class="font-bold theme-text">สถิติผลการตรวจ (แบ่งตามหน่วยงาน)</h3>
                                <p class="text-xs theme-text-muted mt-1">ส่วนรองรับการพัฒนาในอนาคต</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Dashboard (รายการผู้รับบริการ) -->
                <div v-if="page === 'dashboard'" key="dashboard" class="flex flex-col gap-4 h-full overflow-hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 liquid-glass p-4 rounded-2xl shrink-0">
                        <div>
                            <h2 class="text-2xl font-black theme-text">รายการผู้รับบริการ</h2>
                            <p class="theme-text-muted text-sm font-medium mt-1">ปีงบประมาณ {{ config.selectedYear }}</p>
                        </div>
                        <div class="flex gap-3">
                            <button @click="fetchData" class="bg-blue-50 hover:bg-blue-100 text-blue-700 px-4 py-2 rounded-xl shadow-sm transition flex items-center gap-2 text-sm font-bold border border-blue-200">
                                <i class="ph ph-arrows-clockwise text-lg" :class="{'animate-spin': isSpinning}"></i> อัปเดตข้อมูล
                            </button>
                        </div>
                    </div>

                    <div class="liquid-glass rounded-3xl flex flex-col flex-1 min-h-[300px] overflow-hidden">
                        <div class="py-3 px-4 border-b theme-border bg-black/5 flex flex-col lg:flex-row gap-3 lg:items-end shrink-0">
                            <div class="flex-1 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
                                <div><label class="label-sm">จากวันที่รับ</label><input v-model="dashDateStart" type="date" class="input-std font-medium"></div>
                                <div><label class="label-sm">ถึงวันที่รับ</label><input v-model="dashDateEnd" type="date" class="input-std font-medium"></div>
                                <div class="relative">
                                    <label class="label-sm">หน่วยงาน</label>
                                    <select v-model="unitFilter" class="input-std font-bold theme-text appearance-none">
                                        <option value="All" class="font-black text-indigo-600 bg-indigo-50">✦ ทุกหน่วยงาน</option>
                                        <option v-for="u in masterUnits" :key="'duf-'+u" :value="u" class="theme-text font-medium">{{ u }}</option>
                                    </select>
                                    <i class="ph ph-caret-down absolute right-3 top-1/2 -translate-y-[20%] text-slate-400 pointer-events-none"></i>
                                </div>
                                <div class="relative">
                                    <label class="label-sm">ค้นหาอิสระ</label>
                                    <div class="relative"><i class="ph ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-lg"></i><input v-model="searchQuery" type="text" placeholder="Cyto No, HN, ชื่อ..." class="input-std pl-10"></div>
                                </div>
                            </div>
                            <div class="flex flex-col gap-1.5 shrink-0 w-full lg:w-auto">
                                <div class="flex bg-[var(--bg-input)] p-1 rounded-xl border theme-border">
                                    <button @click="statusFilter='All'" :class="['px-3 py-1.5 rounded-lg text-[13px] font-bold transition-colors flex-1 text-center whitespace-nowrap', statusFilter==='All' ? 'bg-black/10 theme-text shadow-sm' : 'theme-text-muted hover:theme-text']">ทั้งหมด</button>
                                    <button @click="statusFilter='Pending'" :class="['px-3 py-1.5 rounded-lg text-[13px] font-bold transition-colors flex-1 text-center whitespace-nowrap', statusFilter==='Pending' ? 'bg-orange-500 text-white shadow-sm' : 'theme-text-muted hover:text-orange-500']">รอผล</button>
                                    <button @click="statusFilter='Reported'" :class="['px-3 py-1.5 rounded-lg text-[13px] font-bold transition-colors flex-1 text-center whitespace-nowrap', statusFilter==='Reported' ? 'bg-emerald-500 text-white shadow-sm' : 'theme-text-muted hover:text-emerald-500']">รายงานแล้ว</button>
                                </div>
                            </div>
                        </div>

                        <div class="overflow-x-auto overflow-y-auto flex-1 relative bg-black/5 custom-scroll">
                            <table class="w-full text-left border-collapse">
                                <thead class="text-[11px] uppercase border-b theme-border font-bold sticky top-0 z-20 shadow-sm"
                                       :class="theme === 'dark' ? 'bg-slate-800 text-slate-300' : (theme === 'eyecare' ? 'bg-[#f0e4cc] text-[#7a6a4f]' : 'bg-slate-200 text-slate-700')">
                                    <tr>
                                        <th class="px-5 py-2 whitespace-nowrap">Cyto No</th>
                                        <th class="px-5 py-2 whitespace-nowrap">HN</th>
                                        <th class="px-5 py-2 whitespace-nowrap">ชื่อ-สกุล</th>
                                        <th class="px-5 py-2 whitespace-nowrap">หน่วยงาน</th>
                                        <th class="px-5 py-2 whitespace-nowrap text-center">TAT (14 days)</th>
                                        <th class="px-5 py-2 whitespace-nowrap text-center">สถานะ</th>
                                        <th class="px-5 py-2 whitespace-nowrap text-center">จัดการ</th>
                                    </tr>
                                </thead>
                                <tbody v-if="isDataLoading"><tr v-for="n in 5" :key="'load-'+n"><td colspan="7" class="px-5 py-3 border-b theme-border"><div class="h-4 bg-black/10 rounded-full animate-pulse"></div></td></tr></tbody>
                                <tbody v-else>
                                    <tr v-for="(p, index) in filteredPatients" :key="'pat-'+index" class="border-b theme-border transition bg-transparent theme-row-hover relative z-0">
                                        <td class="px-5 py-2 font-mono font-bold text-indigo-500 text-[13px]">{{ p.cytoNo }}</td>
                                        <td class="px-5 py-2 theme-text font-medium text-[13px]">{{ p.hn }}</td>
                                        <td class="px-5 py-2 font-bold theme-text whitespace-nowrap text-[13px]"><span class="text-[11px] theme-text-muted font-normal mr-1">{{ p.prefix }}</span>{{ p.fname }} {{ p.lname }}</td>
                                        <td class="px-5 py-2 theme-text truncate max-w-[150px] font-medium text-[12px]" :title="p.unit">{{ p.unit }}</td>
                                        <td class="px-5 py-2 align-middle">
                                            <div class="w-full min-w-[120px] max-w-[150px] mx-auto bg-[var(--border-color)] rounded-full h-3 flex items-center p-[2px] shadow-inner relative overflow-hidden" :title="'ใช้เวลาไป ' + getTAT(p).days + ' วัน'">
                                                <div class="h-full rounded-full transition-all duration-1000 ease-out animate-energy-bar" :class="getTAT(p).colorClass" :style="{ width: getTAT(p).percent + '%' }"></div>
                                                <div v-if="getTAT(p).percent >= 100" class="absolute inset-0 bg-red-500/30 animate-pulse"></div>
                                            </div>
                                            <div class="text-[9px] text-center mt-1 font-bold theme-text-muted">{{ getTAT(p).statusText }}</div>
                                        </td>
                                        <td class="px-5 py-2 text-center">
                                            <span v-if="p.status==='Reported'" class="inline-flex items-center gap-1.5 px-2 py-0.5 rounded-full text-[10px] font-black uppercase tracking-wider bg-emerald-500/10 text-emerald-600 border border-emerald-500/20"><div class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></div> Reported</span>
                                            <span v-else class="inline-flex items-center gap-1.5 px-2 py-0.5 rounded-full text-[10px] font-black uppercase tracking-wider bg-orange-500/10 text-orange-500 border border-orange-500/20"><div class="w-1.5 h-1.5 rounded-full bg-orange-500"></div> Pending</span>
                                        </td>
                                        <td class="px-5 py-2 text-center">
                                            <div class="flex items-center justify-center gap-2">
                                                <button @click="openViewMode(p)" class="w-7 h-7 rounded-lg bg-blue-500/10 text-blue-500 hover:bg-blue-500 hover:text-white transition-colors flex items-center justify-center shadow-sm" title="ดูข้อมูล"><i class="ph ph-eye text-base"></i></button>
                                                <button @click="openEditMode(p)" class="w-7 h-7 rounded-lg bg-amber-500/10 text-amber-500 hover:bg-amber-500 hover:text-white transition-colors flex items-center justify-center shadow-sm" title="แก้ไขข้อมูล"><i class="ph ph-pencil-simple text-base"></i></button>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr v-if="filteredPatients.length === 0 && !isDataLoading"><td colspan="7" class="text-center py-10"><i class="ph ph-folder-open text-4xl theme-text-muted block mb-2 opacity-50"></i><span class="theme-text-muted font-medium text-sm">ไม่พบข้อมูลตามเงื่อนไข</span></td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Registration Form -->
                <div v-else-if="page === 'register'" key="register" class="max-w-7xl mx-auto pb-6 w-full animate-slide-up">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-3">
                            <button @click="page='dashboard'" class="w-9 h-9 rounded-xl bg-[var(--bg-input)] border theme-border flex items-center justify-center theme-text-muted hover:text-pink-500 hover:border-pink-300 transition-all shadow-sm group"><i class="ph ph-arrow-left text-lg group-hover:-translate-x-1 transition-transform"></i></button>
                            <div>
                                <h2 class="text-xl font-black theme-text">{{ viewMode ? 'ข้อมูลสิ่งส่งตรวจ (อ่านอย่างเดียว)' : (isEditMode ? 'แก้ไขข้อมูลผู้ป่วย' : 'ลงทะเบียนสิ่งส่งตรวจใหม่') }}</h2>
                                <p v-if="isEditMode || viewMode" class="text-pink-500 text-[12px] font-bold mt-0.5 bg-pink-500/10 inline-flex items-center gap-1.5 px-2 py-0.5 rounded border border-pink-500/20"><i class="ph ph-identification-badge"></i> Cyto No: <span>{{ formReg.cytoNo }}</span></p>
                                <p v-else class="theme-text-muted text-[10px] font-bold uppercase tracking-widest mt-0.5">New Registration</p>
                            </div>
                        </div>
                    </div>
                    
                    <form @submit.prevent="submitRegister" class="liquid-glass rounded-[1.5rem] overflow-hidden">
                        
                        <div class="grid grid-cols-1 xl:grid-cols-12 border-b theme-border">
                            <div class="xl:col-span-7 p-3 md:p-4 xl:border-r theme-border bg-blue-500/5">
                                <h3 class="text-[12px] font-black text-blue-500 uppercase tracking-widest mb-3 flex items-center gap-2"><i class="ph ph-identification-card text-lg"></i> ข้อมูลทั่วไป</h3>
                                <div class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-x-3 gap-y-2.5">
                                    <div class="col-span-2 md:col-span-1"><label class="label-sm">Cyto No.</label><input type="text" :value="isEditMode || viewMode ? formReg.cytoNo : (formReg.cytoNoPreview || 'กำลังโหลด...')" disabled class="input-std font-bold cursor-not-allowed border-dashed"></div>
                                    <div class="col-span-1"><label class="label-sm">HN (7 หลัก)</label><input v-model="formReg.hn" type="text" maxlength="7" @input="formReg.hn = formReg.hn.replace(/\D/g, '')" class="input-std font-bold focus:ring-2 focus:ring-blue-400" placeholder="ตัวเลข 7 หลัก" :disabled="viewMode"></div>
                                    <div class="col-span-1 md:col-span-2 xl:col-span-2"><label class="label-sm">เลขประจำตัวประชาชน</label><input v-model="formReg.cid" type="text" maxlength="13" @input="formReg.cid = formReg.cid.replace(/\D/g, '')" class="input-std font-medium focus:ring-2 focus:ring-blue-400" placeholder="ตัวเลข 13 หลัก" :disabled="viewMode"></div>
                                    
                                    <div class="col-span-1"><label class="label-sm">คำนำหน้า</label><div class="relative"><select v-model="formReg.prefix" class="input-std font-bold focus:ring-2 focus:ring-blue-400 appearance-none" :disabled="viewMode"><option value="" disabled selected>เลือก...</option><option v-for="(p, i) in prefixes" :key="'p-'+i" :value="p">{{ p }}</option></select><i v-if="!viewMode" class="ph ph-caret-down absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none"></i></div></div>
                                    <div class="col-span-1 md:col-span-2 xl:col-span-1"><label class="label-sm">ชื่อ <span class="text-red-500">*</span></label><input v-model="formReg.fname" type="text" class="input-std font-bold focus:ring-2 focus:ring-blue-400" required :disabled="viewMode"></div>
                                    <div class="col-span-2 md:col-span-3 xl:col-span-2"><label class="label-sm">นามสกุล <span class="text-red-500">*</span></label><input v-model="formReg.lname" type="text" class="input-std font-bold focus:ring-2 focus:ring-blue-400" required :disabled="viewMode"></div>
                                    
                                    <div class="col-span-1"><label class="label-sm">อายุ <span class="text-red-500">*</span></label><input v-model="formReg.age" type="number" class="input-std font-bold focus:ring-2 focus:ring-blue-400" required :disabled="viewMode"></div>
                                    <div class="col-span-1"><label class="label-sm">เพศ</label><select v-model="formReg.sex" :class="['input-std focus:ring-2 focus:ring-blue-400 font-bold', formReg.sex==='ชาย' ? 'text-blue-500' : 'text-pink-500']" :disabled="viewMode"><option value="หญิง" class="text-pink-500">หญิง</option><option value="ชาย" class="text-blue-500">ชาย</option></select></div>
                                    <div class="col-span-1 md:col-span-2 xl:col-span-1"><label class="label-sm">วันที่เก็บ <span class="text-red-500">*</span></label><input v-model="formReg.specimenDate" type="date" class="input-std font-medium focus:ring-2 focus:ring-blue-400" required :disabled="viewMode"></div>
                                    <div class="col-span-1 md:col-span-2 xl:col-span-1"><label class="label-sm">วันที่รับ <span class="text-red-500">*</span></label><input v-model="formReg.receivedDate" type="date" class="input-std font-medium focus:ring-2 focus:ring-blue-400" required :disabled="viewMode"></div>
                                </div>
                            </div>
                            
                            <div class="xl:col-span-5 p-3 md:p-4 bg-orange-500/5 border-t xl:border-t-0 theme-border">
                                <h3 class="text-[12px] font-black text-orange-500 uppercase tracking-widest mb-3 flex items-center gap-2"><i class="ph ph-hospital text-lg"></i> ข้อมูลหน่วยงาน</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-3 gap-y-2.5">
                                    <div class="md:col-span-2 relative unit-dropdown">
                                        <label class="label-sm">หน่วยเก็บ <span class="text-red-500">*</span></label>
                                        <input type="text" v-model="ui.searchUnit" @focus="!viewMode && (ui.showUnitList = true)" class="input-std font-bold focus:ring-2 focus:ring-orange-400" placeholder="พิมพ์เพื่อค้นหา..." required :disabled="viewMode">
                                        <i v-if="!viewMode" class="ph ph-caret-down absolute right-3 top-[26px] text-slate-400 pointer-events-none"></i>
                                        <ul v-show="ui.showUnitList && filteredUnits.length > 0" class="absolute z-10 w-full bg-[var(--bg-input)] border theme-border shadow-xl max-h-48 overflow-y-auto rounded-xl mt-1 backdrop-blur-md">
                                            <li v-for="(u, idx) in filteredUnits" :key="'ul-'+idx" @click.stop="selectUnit(u)" class="px-4 py-2 hover:bg-black/5 cursor-pointer text-[13px] font-medium theme-text border-b theme-border last:border-0">{{ u }}</li>
                                        </ul>
                                    </div>
                                    <div class="relative dist-dropdown">
                                        <label class="label-sm">อำเภอ</label>
                                        <input type="text" v-model="ui.searchDist" @focus="!viewMode && (ui.showDistList = true)" class="input-std font-medium focus:ring-2 focus:ring-orange-400" placeholder="พิมพ์ค้นหา..." :disabled="viewMode">
                                        <i v-if="!viewMode" class="ph ph-caret-down absolute right-3 top-[26px] text-slate-400 pointer-events-none"></i>
                                        <ul v-show="ui.showDistList && filteredDistricts.length > 0" class="absolute z-10 w-full bg-[var(--bg-input)] border theme-border shadow-xl max-h-48 overflow-y-auto rounded-xl mt-1 backdrop-blur-md">
                                            <li v-for="(d, idx) in filteredDistricts" :key="'dl-'+idx" @click.stop="selectDist(d)" class="px-4 py-2 hover:bg-black/5 cursor-pointer text-[13px] font-medium theme-text border-b theme-border last:border-0">{{ d }}</li>
                                        </ul>
                                    </div>
                                    <div><label class="label-sm">รหัส รพ.</label><input v-model="formReg.hcode" type="text" maxlength="10" @input="formReg.hcode = formReg.hcode.replace(/\D/g, '')" class="input-std font-medium focus:ring-2 focus:ring-orange-400" :disabled="viewMode"></div>
                                    <div class="md:col-span-2"><label class="label-sm">ผู้ประสานงาน</label><input v-model="formReg.coordinator" type="text" class="input-std font-medium focus:ring-2 focus:ring-orange-400" :disabled="viewMode"></div>
                                    <div class="md:col-span-2"><label class="label-sm">โทรศัพท์</label><input v-model="formReg.phone" type="text" @input="formReg.phone = formReg.phone.replace(/[^0-9-]/g, '')" class="input-std font-bold focus:ring-2 focus:ring-orange-400 tracking-wider" :disabled="viewMode"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="p-3 md:p-4 bg-emerald-500/5">
                            <h3 class="text-[12px] font-black text-emerald-500 uppercase tracking-widest mb-3 flex items-center gap-2"><i class="ph ph-heartbeat text-lg"></i> ข้อมูลทางคลินิก</h3>
                            <div class="grid grid-cols-2 md:grid-cols-4 xl:grid-cols-6 gap-x-3 gap-y-2.5">
                                <div class="col-span-1"><label class="label-sm">Para</label><input v-model="formReg.para" type="text" maxlength="6" @input="formReg.para = formReg.para.replace(/\D/g, '')" class="input-std font-bold focus:ring-2 focus:ring-emerald-400 text-center" :disabled="viewMode"></div>
                                <div class="col-span-1"><label class="label-sm">Last</label><input v-model="formReg.last" type="text" maxlength="3" @input="formReg.last = formReg.last.replace(/\D/g, '')" class="input-std font-bold focus:ring-2 focus:ring-emerald-400 text-center" :disabled="viewMode"></div>
                                <div class="col-span-2">
                                    <label class="label-sm">LMP</label>
                                    <select v-model="ui.lmpType" class="input-std font-medium focus:ring-2 focus:ring-emerald-400" :class="{'mb-1.5': ui.lmpType === 'ระบุวันที่'}" :disabled="viewMode">
                                        <option value="ระบุวันที่">ระบุวันที่</option><option value="หมดประจำเดือน">หมดประจำเดือน</option><option value="จำไม่ได้">จำไม่ได้</option><option value="หลังคลอด">หลังคลอด</option>
                                    </select>
                                    <input v-if="ui.lmpType === 'ระบุวันที่'" v-model="ui.lmpDate" type="date" class="input-std font-medium focus:ring-2 focus:ring-emerald-400 animate-slide-up" :disabled="viewMode">
                                </div>
                                
                                <div class="col-span-2 xl:col-span-2 relative contra-dropdown">
                                    <label class="label-sm">การคุมกำเนิด</label>
                                    <input type="text" v-model="ui.searchContra" @focus="!viewMode && (ui.showContraList = true)" class="input-std font-medium focus:ring-2 focus:ring-emerald-400" :class="{'mb-1.5': ui.searchContra === 'อื่นๆ (ระบุ)'}" placeholder="พิมพ์เพื่อค้นหา..." :disabled="viewMode">
                                    <i v-if="!viewMode" class="ph ph-caret-down absolute right-3 top-[26px] text-slate-400 pointer-events-none"></i>
                                    <ul v-show="ui.showContraList && filteredContras.length > 0" class="absolute z-10 w-full bg-[var(--bg-input)] border theme-border shadow-xl max-h-48 overflow-y-auto rounded-xl mt-1 backdrop-blur-md">
                                        <li v-for="(c, idx) in filteredContras" :key="'cl-'+idx" @click.stop="selectContra(c)" class="px-3 py-2 hover:bg-black/5 cursor-pointer text-[13px] font-medium theme-text border-b theme-border">{{ c }}</li>
                                    </ul>
                                    <input v-if="ui.searchContra === 'อื่นๆ (ระบุ)'" v-model="ui.contraOtherText" type="text" class="input-std font-medium focus:ring-2 focus:ring-emerald-400 animate-slide-up" placeholder="ระบุอื่นๆ..." :disabled="viewMode">
                                </div>
                                
                                <div class="col-span-2 md:col-span-4 xl:col-span-4 relative prevtx-dropdown">
                                    <label class="label-sm">Previous treatment</label>
                                    <div @click="!viewMode && (ui.showPrevTxList = !ui.showPrevTxList)" class="input-std font-medium focus:ring-2 focus:ring-emerald-400 min-h-[32px] flex flex-wrap gap-1.5 items-center relative" :class="viewMode ? 'cursor-not-allowed bg-black/5' : 'cursor-pointer'">
                                        <span v-if="ui.prevTxSelections.length === 0" class="text-slate-400 font-normal">ไม่มีข้อมูล...</span>
                                        <span v-for="(item, idx) in ui.prevTxSelections" :key="idx" class="bg-emerald-500/10 text-emerald-600 px-1.5 py-0.5 rounded text-[11px] flex items-center gap-1 font-bold border border-emerald-500/20 shadow-sm">
                                            {{ item }} <i v-if="!viewMode" class="ph ph-x cursor-pointer hover:text-emerald-800 ml-1 font-bold" @click.stop="togglePrevTx(item)"></i>
                                        </span>
                                        <i v-if="!viewMode" class="ph ph-caret-down absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none"></i>
                                    </div>
                                    <ul v-show="ui.showPrevTxList" class="absolute z-20 w-full bg-[var(--bg-input)] border theme-border shadow-xl max-h-48 overflow-y-auto rounded-xl mt-1 backdrop-blur-md">
                                        <li v-for="(pt, idx) in masterPrevTx" :key="'pt-'+idx" class="px-3 py-2 hover:bg-black/5 cursor-pointer text-[13px] theme-text flex items-center border-b theme-border font-medium">
                                            <input type="checkbox" :value="pt" v-model="ui.prevTxSelections" class="mr-3 text-emerald-500 focus:ring-emerald-500 rounded cursor-pointer w-4 h-4">
                                            <span @click.prevent="togglePrevTx(pt)" class="flex-1">{{ pt }}</span>
                                        </li>
                                    </ul>
                                    <input v-if="ui.prevTxSelections.includes('อื่น ๆ (ระบุ)')" v-model="ui.prevTxOtherText" type="text" class="input-std font-medium focus:ring-2 focus:ring-emerald-400 mt-1.5 animate-slide-up" placeholder="ระบุอื่นๆ..." :disabled="viewMode">
                                </div>
                                
                                <div class="col-span-2"><label class="label-sm">Last Pap (5 yrs)</label><input v-model="formReg.lastPap" type="text" class="input-std font-medium focus:ring-2 focus:ring-emerald-400" :disabled="viewMode"></div>
                                <div class="col-span-2 md:col-span-4 xl:col-span-4"><label class="label-sm">Clinical Findings</label><input v-model="formReg.clinFind" type="text" class="input-std font-medium focus:ring-2 focus:ring-emerald-400" :disabled="viewMode"></div>
                                
                                <div class="col-span-2 md:col-span-2 xl:col-span-3 relative">
                                    <label class="label-sm">Diagnosis</label>
                                    <input v-model="formReg.clinDx" list="dxList" type="text" class="input-std font-bold text-emerald-600 focus:ring-2 focus:ring-emerald-400" placeholder="พิมพ์หรือเลือก" :disabled="viewMode">
                                    <datalist id="dxList"><option value="Screening"></option></datalist>
                                </div>
                                
                                <div class="col-span-2 md:col-span-2 xl:col-span-3">
                                    <label class="label-sm">Method <span class="text-red-500">*</span></label>
                                    <select v-model="formReg.method" required class="input-std font-black focus:ring-2 focus:ring-emerald-400 appearance-none" :class="getMethodColor(formReg.method)" :disabled="viewMode">
                                        <option value="" disabled selected class="text-slate-400 font-normal">เลือก Method</option>
                                        <option value="Conventional cytology" class="text-slate-700 font-bold">Conventional cytology</option>
                                        <option value="Liquid-based cytology" class="text-indigo-600 font-bold">Liquid-based cytology</option>
                                        <option value="Liquid-based cytology [HPV โครงการ]" class="text-emerald-600 font-bold">Liquid-based cytology [HPV โครงการ]</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div v-if="!viewMode" class="bg-black/5 p-3 flex flex-col md:flex-row justify-end gap-3 border-t theme-border">
                            <button type="button" @click="page='dashboard'" class="px-6 py-2 rounded-xl theme-text-muted hover:theme-text hover:bg-black/10 transition font-bold text-[13px]">ยกเลิก</button>
                            <button type="submit" class="px-8 py-2 rounded-xl bg-gradient-to-r from-pink-500 to-rose-500 text-white font-black shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-0.5 text-[13px]">
                                {{ isEditMode ? 'บันทึกการแก้ไข' : 'บันทึกข้อมูลใหม่' }}
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Report List -->
                <div v-else-if="page === 'report_list'" key="report_list" class="flex flex-col gap-4 h-full animate-slide-up overflow-hidden">
                    
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 liquid-glass p-4 rounded-2xl shrink-0">
                        <div>
                            <h2 class="text-2xl font-black theme-text">รายงานผลทางเซลล์วิทยา (Cytology Report)</h2>
                            <p class="theme-text-muted text-sm font-medium mt-1">ปีงบประมาณ {{ config.selectedYear }}</p>
                        </div>
                        <div class="flex gap-3">
                            <button @click="fetchData" class="bg-emerald-50 hover:bg-emerald-100 text-emerald-700 px-4 py-2 rounded-xl shadow-sm transition flex items-center gap-2 text-sm font-bold border border-emerald-200">
                                <i class="ph ph-arrows-clockwise text-lg" :class="{'animate-spin': isSpinning}"></i> อัปเดตข้อมูล
                            </button>
                        </div>
                    </div>
                    
                    <div class="liquid-glass rounded-3xl flex flex-col flex-1 min-h-[300px] overflow-hidden">
                        
                        <div class="py-3 px-4 border-b theme-border bg-black/5 flex flex-col lg:flex-row gap-3 lg:items-end shrink-0">
                            <div class="flex-1 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
                                <div><label class="label-sm">จากวันที่รับ</label><input v-model="ui.reportDateStart" type="date" class="input-std focus:ring-2 focus:ring-emerald-400 font-medium"></div>
                                <div><label class="label-sm">ถึงวันที่รับ</label><input v-model="ui.reportDateEnd" type="date" class="input-std focus:ring-2 focus:ring-emerald-400 font-medium"></div>
                                <div class="relative">
                                    <label class="label-sm">หน่วยงาน</label>
                                    <select v-model="unitFilter" class="input-std focus:ring-2 focus:ring-emerald-400 appearance-none font-bold">
                                        <option value="All" class="font-black text-indigo-600 bg-indigo-50">✦ ทุกหน่วยงาน</option>
                                        <option v-for="u in masterUnits" :key="'ru-'+u" :value="u" class="theme-text font-medium">{{ u }}</option>
                                    </select>
                                    <i class="ph ph-caret-down absolute right-3 top-1/2 -translate-y-[20%] text-slate-400 pointer-events-none"></i>
                                </div>
                                <div class="relative">
                                    <label class="label-sm">ค้นหาอิสระ</label>
                                    <div class="relative"><i class="ph ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-lg"></i><input v-model="ui.reportSearch" type="text" placeholder="Cyto No, HN, ชื่อ..." class="input-std focus:ring-2 focus:ring-emerald-400 pl-10"></div>
                                </div>
                            </div>
                            <div class="flex flex-col gap-1.5 shrink-0 w-full lg:w-auto">
                                <div class="flex bg-[var(--bg-input)] p-1 rounded-xl border theme-border">
                                    <button @click="statusFilter='All'" :class="['px-3 py-1.5 rounded-lg text-[13px] font-bold transition-colors flex-1 text-center whitespace-nowrap', statusFilter==='All' ? 'bg-black/10 theme-text shadow-sm' : 'theme-text-muted hover:theme-text']">ทั้งหมด</button>
                                    <button @click="statusFilter='Pending'" :class="['px-3 py-1.5 rounded-lg text-[13px] font-bold transition-colors flex-1 text-center whitespace-nowrap', statusFilter==='Pending' ? 'bg-orange-500 text-white shadow-sm' : 'theme-text-muted hover:text-orange-500']">รอผล</button>
                                    <button @click="statusFilter='Reported'" :class="['px-3 py-1.5 rounded-lg text-[13px] font-bold transition-colors flex-1 text-center whitespace-nowrap', statusFilter==='Reported' ? 'bg-emerald-500 text-white shadow-sm' : 'theme-text-muted hover:text-emerald-500']">รายงานแล้ว</button>
                                </div>
                            </div>
                        </div>

                        <div class="overflow-x-auto overflow-y-auto flex-1 relative bg-black/5 custom-scroll">
                            <table class="w-full text-left border-collapse">
                                <thead class="text-[11px] uppercase border-b theme-border font-bold sticky top-0 z-20 shadow-sm"
                                       :class="theme === 'dark' ? 'bg-slate-800 text-slate-300' : (theme === 'eyecare' ? 'bg-[#f0e4cc] text-[#7a6a4f]' : 'bg-slate-200 text-slate-700')">
                                    <tr><th class="px-5 py-2 whitespace-nowrap">Cyto No</th><th class="px-5 py-2 whitespace-nowrap">HN</th><th class="px-5 py-2 whitespace-nowrap">ชื่อ-สกุล</th><th class="px-5 py-2 whitespace-nowrap">หน่วยงาน</th><th class="px-5 py-2 whitespace-nowrap text-center">TAT (14 days)</th><th class="px-5 py-2 whitespace-nowrap text-center">สถานะ</th><th class="px-5 py-2 whitespace-nowrap text-center">จัดการ</th></tr>
                                </thead>
                                <tbody v-if="isDataLoading"><tr v-for="n in 5" :key="'load-'+n"><td colspan="7" class="px-5 py-3 border-b theme-border"><div class="h-4 bg-black/10 rounded-full animate-pulse"></div></td></tr></tbody>
                                <tbody v-else>
                                    <tr v-for="(p, index) in filteredReportPatients" :key="'rpat-'+index" class="border-b theme-border transition bg-transparent theme-row-hover relative z-0">
                                        <td class="px-5 py-2 font-mono font-bold text-emerald-500 text-[13px]">{{ p.cytoNo }}</td>
                                        <td class="px-5 py-2 theme-text font-medium text-[13px]">{{ p.hn }}</td>
                                        <td class="px-5 py-2 font-bold theme-text whitespace-nowrap text-[13px]"><span class="text-[11px] theme-text-muted font-normal mr-1">{{ p.prefix }}</span> {{ p.fname }} {{ p.lname }}</td>
                                        <td class="px-5 py-2 theme-text truncate max-w-[150px] font-medium text-[12px]" :title="p.unit">{{ p.unit }}</td>
                                        <td class="px-5 py-2 align-middle">
                                            <div class="w-full min-w-[120px] max-w-[150px] mx-auto bg-[var(--border-color)] rounded-full h-3 flex items-center p-[2px] shadow-inner relative overflow-hidden" :title="'ใช้เวลาไป ' + getTAT(p).days + ' วัน'">
                                                <div class="h-full rounded-full transition-all duration-1000 ease-out animate-energy-bar" :class="getTAT(p).colorClass" :style="{ width: getTAT(p).percent + '%' }"></div>
                                                <div v-if="getTAT(p).percent >= 100" class="absolute inset-0 bg-red-500/30 animate-pulse"></div>
                                            </div>
                                            <div class="text-[9px] text-center mt-1 font-bold theme-text-muted">{{ getTAT(p).statusText }}</div>
                                        </td>
                                        <td class="px-5 py-2 text-center">
                                            <span v-if="p.status==='Reported'" class="inline-flex items-center gap-1.5 px-2 py-0.5 rounded-full text-[10px] font-black uppercase tracking-wider bg-emerald-500/10 text-emerald-600 border border-emerald-500/20"><div class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></div> Reported</span>
                                            <span v-else class="inline-flex items-center gap-1.5 px-2 py-0.5 rounded-full text-[10px] font-black uppercase tracking-wider bg-orange-500/10 text-orange-500 border border-orange-500/20"><div class="w-1.5 h-1.5 rounded-full bg-orange-500"></div> Pending</span>
                                        </td>
                                        <td class="px-5 py-2 text-center">
                                            <div v-if="p.status==='Pending'" class="flex justify-center">
                                                <button @click="openReportForm(p, false)" class="px-3 py-1.5 rounded-lg font-bold text-[11px] bg-gradient-to-r from-emerald-400 to-teal-500 text-white hover:shadow-lg hover:-translate-y-0.5 transition flex items-center gap-1.5">
                                                    <i class="ph ph-flask text-sm"></i> รายงานผล
                                                </button>
                                            </div>
                                            <div v-else class="flex justify-center gap-2">
                                                <button @click="openReportForm(p, true)" class="w-7 h-7 rounded-lg bg-blue-500/10 text-blue-500 hover:bg-blue-500 hover:text-white transition-colors flex items-center justify-center shadow-sm" title="ดูผล"><i class="ph ph-eye text-base"></i></button>
                                                <button @click="openReportForm(p, false)" class="w-7 h-7 rounded-lg bg-amber-500/10 text-amber-500 hover:bg-amber-500 hover:text-white transition-colors flex items-center justify-center shadow-sm" title="แก้ไขผล"><i class="ph ph-pencil-simple text-base"></i></button>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr v-if="filteredReportPatients.length === 0 && !isDataLoading"><td colspan="7" class="text-center py-10"><i class="ph ph-folder-open text-4xl theme-text-muted block mb-2 opacity-50"></i><span class="theme-text-muted font-medium text-sm">ไม่พบข้อมูล</span></td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Report Form (อัปเดต 2-Column Grid ลดการ Scroll) -->
                <div v-else-if="page === 'report_form'" key="report_form" class="max-w-[1600px] mx-auto pb-6 w-full animate-slide-up">
                    <div class="flex items-center gap-3 mb-3">
                        <button @click="page='report_list'" class="w-9 h-9 rounded-xl bg-[var(--bg-input)] border theme-border flex items-center justify-center theme-text-muted hover:text-emerald-500 hover:border-emerald-300 transition-all shadow-sm group"><i class="ph ph-arrow-left text-lg group-hover:-translate-x-1 transition-transform"></i></button>
                        <div>
                            <h2 class="text-xl font-black theme-text">{{ viewMode ? 'THE BETHESDA 2001 CYTOLOGIC REPORT (อ่านอย่างเดียว)' : 'THE BETHESDA 2001 CYTOLOGIC REPORT' }}</h2>
                            <p class="text-emerald-500 text-[12px] font-bold mt-0.5 bg-emerald-500/10 inline-flex items-center gap-1.5 px-2 py-0.5 rounded border border-emerald-500/20">Cyto No: <span>{{ formReport.patient.cytoNo }}</span></p>
                        </div>
                    </div>

                    <!-- Patient Info (Progressive Disclosure) -->
                    <div class="liquid-glass rounded-2xl mb-3 overflow-hidden shadow-sm">
                        <div class="p-3 bg-[var(--bg-card)] border-b theme-border flex justify-between items-center cursor-pointer hover:bg-black/5 transition" @click="ui.showPatientInfo = !ui.showPatientInfo">
                            <h3 class="font-black theme-text flex items-center gap-2 text-[14px]"><i class="ph ph-user-circle text-lg text-indigo-500"></i> ข้อมูลผู้ป่วย (Patient Info)</h3>
                            <button class="bg-[var(--bg-input)] hover:brightness-95 theme-text w-7 h-7 rounded-lg flex items-center justify-center transition shadow-sm border theme-border">
                                <i class="ph ph-caret-up transition-transform duration-300" :class="!ui.showPatientInfo ? 'rotate-180' : ''"></i>
                            </button>
                        </div>
                        <div v-show="!ui.showPatientInfo" class="p-3 bg-[var(--bg-input)] flex flex-wrap items-center gap-2 text-[13px] animate-slide-up">
                            <div class="bg-emerald-500/10 border border-emerald-500/20 px-2.5 py-1 rounded-lg flex items-center gap-1.5 shadow-sm">
                                <i class="ph ph-flask text-emerald-500 text-base"></i>
                                <span class="font-black text-emerald-500 tracking-wider">{{ formReport.patient.cytoNo }}</span>
                            </div>
                            <div :class="['px-2.5 py-1 rounded-lg flex items-center gap-1.5 border shadow-sm', formReport.patient.sex === 'ชาย' ? 'bg-blue-500/10 border-blue-500/20 text-blue-500' : 'bg-pink-500/10 border-pink-500/20 text-pink-500']">
                                <i :class="['ph text-base', formReport.patient.sex === 'ชาย' ? 'ph-gender-male' : 'ph-gender-female']"></i>
                                <span class="font-bold"><span class="text-[10px] font-normal opacity-80 mr-1">{{ formReport.patient.prefix }}</span>{{ formReport.patient.fname }} {{ formReport.patient.lname }}</span>
                            </div>
                            <div class="bg-[var(--bg-card)] border theme-border px-2.5 py-1 rounded-lg flex items-center gap-1.5 shadow-sm">
                                <i class="ph ph-calendar-blank theme-text-muted text-base"></i>
                                <span class="font-bold theme-text">{{ formReport.patient.age }} <span class="text-[10px] font-normal theme-text-muted">ปี</span></span>
                            </div>
                            <div class="ml-auto flex items-center">
                                <span :class="getMethodColor(formReport.patient.method) + ' shadow-sm block text-[12px]'"><i class="ph ph-microscope mr-1.5"></i>{{ formReport.patient.method || '-' }}</span>
                            </div>
                        </div>
                        <div v-show="ui.showPatientInfo" class="p-4 text-[13px] bg-[var(--bg-input)] animate-slide-up">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-y-3 gap-x-6">
                                <div class="col-span-full flex flex-wrap gap-x-6 gap-y-2 border-b theme-border pb-2">
                                    <div><span class="text-[10px] font-bold theme-text-muted uppercase tracking-widest block mb-0.5">Cytologic No.</span> <span class="font-black text-lg text-emerald-500">{{ formReport.patient.cytoNo }}</span></div>
                                    <div><span class="text-[10px] font-bold theme-text-muted uppercase tracking-widest block mb-0.5">ID Number</span> <span class="font-bold theme-text text-base">{{ formReport.patient.cid || '-' }}</span></div>
                                    <div><span class="text-[10px] font-bold theme-text-muted uppercase tracking-widest block mb-0.5">HN</span> <span class="font-bold theme-text text-base">{{ formReport.patient.hn || '-' }}</span></div>
                                </div>
                                <div class="col-span-full flex flex-wrap gap-x-6 gap-y-2 border-b theme-border pb-2">
                                    <div><span class="text-[10px] font-bold theme-text-muted uppercase tracking-widest block mb-0.5">Name</span> <span class="font-bold theme-text text-[14px]"><span class="text-[11px] font-normal theme-text-muted mr-1">{{ formReport.patient.prefix }}</span>{{ formReport.patient.fname }} {{ formReport.patient.lname }}</span></div>
                                    <div><span class="text-[10px] font-bold theme-text-muted uppercase tracking-widest block mb-0.5">Age</span> <span class="font-bold theme-text text-[14px]">{{ formReport.patient.age }} <span class="text-[11px] font-normal theme-text-muted">ปี</span></span></div>
                                    <div><span class="text-[10px] font-bold theme-text-muted uppercase tracking-widest block mb-0.5">Sex</span> <span :class="['font-black text-[14px] px-2 py-0.5 rounded border', formReport.patient.sex === 'หญิง' ? 'bg-pink-500/10 text-pink-500 border-pink-500/20' : 'bg-blue-500/10 text-blue-500 border-blue-500/20']">{{ formReport.patient.sex }}</span></div>
                                </div>
                                <div class="col-span-full flex flex-wrap gap-x-6 gap-y-2 border-b theme-border pb-2">
                                    <div><span class="text-[10px] font-bold theme-text-muted uppercase tracking-widest block mb-0.5">Taken</span> <span class="font-bold theme-text">{{ formReport.patient.specimenDate || '-' }}</span></div>
                                    <div><span class="text-[10px] font-bold theme-text-muted uppercase tracking-widest block mb-0.5">Received</span> <span class="font-bold theme-text">{{ formReport.patient.recDate || '-' }}</span></div>
                                    <div><span class="text-[10px] font-bold theme-text-muted uppercase tracking-widest block mb-0.5">Department</span> <span class="font-bold theme-text">{{ formReport.patient.unit }}</span></div>
                                </div>
                                <div class="col-span-full">
                                    <span class="text-[10px] font-bold theme-text-muted uppercase tracking-widest block mb-1">Method of pap smear</span> 
                                    <span :class="['font-black text-[12px] px-2.5 py-1 rounded-lg border shadow-sm inline-block', formReport.patient.method === 'Conventional cytology' ? 'bg-slate-200/50 theme-text border-slate-300/50' : (formReport.patient.method === 'Liquid-based cytology' ? 'bg-indigo-500/10 text-indigo-600 border-indigo-500/20' : 'bg-emerald-500/10 text-emerald-600 border-emerald-500/20')]">{{ formReport.patient.method || '-' }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <form @submit.prevent="submitReport" class="liquid-glass rounded-[1.5rem] overflow-hidden shadow-md">
                        
                        <!-- NEW: 2-Column Grid Layout for Desktop to prevent scroll -->
                        <div class="grid grid-cols-1 lg:grid-cols-2">
                            
                            <!-- ================= LEFT COLUMN ================= -->
                            <div class="flex flex-col border-b lg:border-b-0 lg:border-r theme-border h-full">
                                
                                <!-- 1. SPECIMEN ADEQUACY -->
                                <div class="p-3 md:p-4 bg-emerald-500/5 border-b theme-border">
                                    <h3 class="font-black text-emerald-600 mb-3 text-[14px] border-l-[3px] border-emerald-500 pl-2">1. SPECIMEN ADEQUACY</h3>
                                    <div class="space-y-2">
                                        <div class="flex flex-col gap-2">
                                            <label class="flex items-center gap-2 p-2 border theme-border rounded-lg transition w-full" :class="[viewMode ? 'cursor-not-allowed' : 'cursor-pointer hover:bg-black/5', formReport.adequacy==='010 Satisfactory' ? 'border-emerald-500 bg-emerald-500/10 ring-2 ring-emerald-500/30' : 'bg-[var(--bg-input)]']">
                                                <input type="radio" v-model="formReport.adequacy" value="010 Satisfactory" class="text-emerald-500 focus:ring-emerald-500 w-3.5 h-3.5" :disabled="viewMode">
                                                <span class="theme-text font-bold text-[13px]">010 Satisfactory</span>
                                            </label>
                                            <label class="flex items-center gap-2 p-2 border theme-border rounded-lg transition w-full" :class="[viewMode ? 'cursor-not-allowed' : 'cursor-pointer hover:bg-black/5', formReport.adequacy==='030 Unsatisfactory for evaluation' ? 'border-rose-500 bg-rose-500/10 ring-2 ring-rose-500/30' : 'bg-[var(--bg-input)]']">
                                                <input type="radio" v-model="formReport.adequacy" value="030 Unsatisfactory for evaluation" class="text-rose-500 focus:ring-rose-500 w-3.5 h-3.5" :disabled="viewMode">
                                                <span class="theme-text font-bold text-[13px]">030 Unsatisfactory for evaluation</span>
                                            </label>
                                        </div>
                                        <div v-if="formReport.adequacy" class="animate-slide-up bg-emerald-500/10 p-2.5 rounded-lg border border-emerald-500/20">
                                            <label class="label-sm text-emerald-600">รายละเอียด <span class="text-red-500">*</span></label>
                                            <select v-model="formReport.adequacyDetail" class="input-std focus:ring-2 focus:ring-emerald-500 font-bold mt-1 text-[12px] py-1.5" required :disabled="viewMode">
                                                <option value="" disabled selected>เลือกรายละเอียด...</option>
                                                <option v-for="(opt, idx) in adequacyDetailOptions" :key="'adq-'+idx" :value="opt.text">{{ opt.text }}</option>
                                            </select>
                                        </div>
                                        <div class="bg-[var(--bg-input)] p-2.5 rounded-lg border theme-border shadow-sm flex flex-col md:flex-row gap-2">
                                            <div class="flex-1">
                                                <label class="label-sm">Additional (เพิ่มเติม)</label>
                                                <select v-model="formReport.additional" class="input-std focus:ring-2 focus:ring-emerald-500 font-bold text-[12px] py-1.5 mt-1" :disabled="viewMode">
                                                    <option value="">ไม่ระบุ</option>
                                                    <option v-for="(opt, idx) in additionalOptions" :key="'add-'+idx" :value="opt.text">{{ opt.text }}</option>
                                                </select>
                                            </div>
                                            <div class="flex-1" v-if="formReport.additional === '029 Other'">
                                                <label class="label-sm">ระบุอื่นๆ</label>
                                                <input v-model="ui.reportAdditionalOther" type="text" class="input-std focus:ring-2 focus:ring-emerald-500 animate-slide-up font-bold text-[12px] py-1.5 mt-1" placeholder="ระบุ..." :disabled="viewMode">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 2. GEN CAT: 100 NEGATIVE -->
                                <div class="p-3 md:p-4 bg-violet-500/5 flex-1">
                                    <h3 class="font-black text-violet-600 mb-3 text-[14px] border-l-[3px] border-violet-500 pl-2">2. GENERAL CATEGORIZATION</h3>
                                    
                                    <div class="border theme-border rounded-xl p-3 bg-[var(--bg-card)] shadow-sm relative overflow-visible mb-3">
                                        <label class="text-[12px] font-black text-violet-700 tracking-tight block mb-2">100 NEGATIVE FOR INTRAEPITHELIAL LESION OR MALIGNANCY</label>
                                        <div class="space-y-3">
                                            <!-- Organism -->
                                            <div class="relative organism-dropdown">
                                                <label class="label-sm text-[11px] mb-1">Organism</label>
                                                <div @click="!viewMode && (ui.showOrganismList = !ui.showOrganismList)" class="input-std font-medium focus:ring-2 focus:ring-violet-500 min-h-[32px] flex flex-wrap gap-1 items-center relative py-1" :class="viewMode ? 'cursor-not-allowed bg-black/5' : 'cursor-pointer'">
                                                    <span v-if="formReport.organismSelections.length === 0" class="text-slate-400 font-normal text-[12px]">ไม่ได้ระบุ...</span>
                                                    <span v-for="(item, idx) in formReport.organismSelections" :key="'os-'+idx" class="bg-violet-500/10 text-violet-600 px-1.5 py-0.5 rounded text-[10px] flex items-center gap-1 font-bold border border-violet-500/20">
                                                        {{ item }} <i v-if="!viewMode" class="ph ph-x cursor-pointer hover:text-violet-800 ml-1 font-bold" @click.stop="toggleOrganism(item)"></i>
                                                    </span>
                                                    <i v-if="!viewMode" class="ph ph-caret-down absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none text-sm"></i>
                                                </div>
                                                <ul v-show="ui.showOrganismList" class="absolute z-30 w-full bg-[var(--bg-input)] border theme-border shadow-xl max-h-48 overflow-y-auto rounded-xl mt-1 backdrop-blur-md">
                                                    <li v-for="(org, idx) in masterOrganism" :key="'mo-'+idx" class="px-3 py-1.5 hover:bg-black/5 cursor-pointer text-[12px] theme-text flex items-center border-b theme-border font-medium">
                                                        <input type="checkbox" :value="org" v-model="formReport.organismSelections" class="mr-2 text-violet-500 focus:ring-violet-500 rounded cursor-pointer w-3.5 h-3.5">
                                                        <span @click.prevent="toggleOrganism(org)" class="flex-1">{{ org }}</span>
                                                    </li>
                                                </ul>
                                                <input v-if="formReport.organismSelections.includes('109 Other organism')" v-model="formReport.organismOtherText" type="text" class="input-std font-medium focus:ring-2 focus:ring-violet-400 mt-1.5 py-1.5 text-[12px] animate-slide-up" placeholder="ระบุอื่นๆ (บังคับ)..." :disabled="viewMode" required>
                                            </div>

                                            <!-- Non-neoplastic -->
                                            <div class="relative nonneo-dropdown">
                                                <label class="label-sm text-[10px] mb-1 leading-tight">Other non neoplastic finding Reactive cellular changes associated with</label>
                                                <div @click="!viewMode && (ui.showNonNeoList = !ui.showNonNeoList)" class="input-std font-medium focus:ring-2 focus:ring-violet-500 min-h-[32px] flex flex-wrap gap-1 items-center relative py-1" :class="viewMode ? 'cursor-not-allowed bg-black/5' : 'cursor-pointer'">
                                                    <span v-if="formReport.nonNeoSelections.length === 0" class="text-slate-400 font-normal text-[12px]">ไม่ได้ระบุ...</span>
                                                    <span v-for="(item, idx) in formReport.nonNeoSelections" :key="'ns-'+idx" class="bg-violet-500/10 text-violet-600 px-1.5 py-0.5 rounded text-[10px] flex items-center gap-1 font-bold border border-violet-500/20">
                                                        {{ item }} <i v-if="!viewMode" class="ph ph-x cursor-pointer hover:text-violet-800 ml-1 font-bold" @click.stop="toggleNonNeo(item)"></i>
                                                    </span>
                                                    <i v-if="!viewMode" class="ph ph-caret-down absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none text-sm"></i>
                                                </div>
                                                <ul v-show="ui.showNonNeoList" class="absolute z-20 w-full bg-[var(--bg-input)] border theme-border shadow-xl max-h-48 overflow-y-auto rounded-xl mt-1 backdrop-blur-md">
                                                    <li v-for="(nn, idx) in masterNonNeo" :key="'mnn-'+idx" class="px-3 py-1.5 hover:bg-black/5 cursor-pointer text-[12px] theme-text flex items-center border-b theme-border font-medium">
                                                        <input type="checkbox" :value="nn" v-model="formReport.nonNeoSelections" class="mr-2 text-violet-500 focus:ring-violet-500 rounded cursor-pointer w-3.5 h-3.5">
                                                        <span @click.prevent="toggleNonNeo(nn)" class="flex-1">{{ nn }}</span>
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                            </div>

                            <!-- ================= RIGHT COLUMN ================= -->
                            <div class="flex flex-col h-full bg-amber-500/5">
                                
                                <!-- 2. GEN CAT: 200 EPITHELIAL -->
                                <div class="p-3 md:p-4 border-b theme-border flex-1">
                                    <div class="flex justify-between items-center mb-3">
                                        <h3 class="font-black text-amber-600 text-[14px] border-l-[3px] border-amber-500 pl-2">200 EPITHELIAL CELLS ABNORMALITIES</h3>
                                    </div>
                                    
                                    <div class="space-y-4">
                                        
                                        <!-- === SQUAMOUS CELL === -->
                                        <div class="bg-[var(--bg-card)] border theme-border rounded-xl p-3 shadow-sm">
                                            <h4 class="text-[12px] font-bold text-amber-700 uppercase tracking-widest mb-2 border-b border-amber-500/20 pb-1">Squamous Cell</h4>
                                            
                                            <div class="space-y-1.5">
                                                <label class="flex items-start gap-2 text-[12px] theme-text font-medium cursor-pointer hover:bg-black/5 p-1 rounded transition" :class="{'opacity-50 cursor-not-allowed': viewMode}">
                                                    <input type="radio" v-model="formReport.squamousMain" value="" class="mt-0.5 w-3.5 h-3.5 text-amber-500 focus:ring-amber-500" :disabled="viewMode"> <span>(ไม่ระบุ)</span>
                                                </label>
                                                
                                                <!-- Atypical squamous cell -->
                                                <div class="flex flex-col gap-1">
                                                    <label class="flex items-start gap-2 text-[12px] theme-text font-bold cursor-pointer hover:bg-black/5 p-1 rounded transition" :class="{'bg-amber-500/10': formReport.squamousMain==='Atypical squamous cell', 'opacity-50 cursor-not-allowed': viewMode}">
                                                        <input type="radio" v-model="formReport.squamousMain" value="Atypical squamous cell" class="mt-0.5 w-3.5 h-3.5 text-amber-500 focus:ring-amber-500" :disabled="viewMode"> <span>Atypical squamous cell</span>
                                                    </label>
                                                    <div v-show="formReport.squamousMain === 'Atypical squamous cell'" class="ml-5 pl-2 border-l-2 border-amber-200 space-y-1 animate-slide-up">
                                                        <label class="flex items-center gap-2 text-[11px] theme-text cursor-pointer hover:bg-black/5 p-1 rounded"><input type="radio" v-model="formReport.squamousSubSingle" value="211 of undetermined significance (ASC-US)" :required="formReport.squamousMain === 'Atypical squamous cell'" class="w-3 h-3 text-amber-500 focus:ring-amber-500" :disabled="viewMode"> 211 of undetermined significance (ASC-US)</label>
                                                        <label class="flex items-center gap-2 text-[11px] theme-text cursor-pointer hover:bg-black/5 p-1 rounded"><input type="radio" v-model="formReport.squamousSubSingle" value="212 Cannot exclude HSIL (ASC-H)" :required="formReport.squamousMain === 'Atypical squamous cell'" class="w-3 h-3 text-amber-500 focus:ring-amber-500" :disabled="viewMode"> 212 Cannot exclude HSIL (ASC-H)</label>
                                                    </div>
                                                </div>

                                                <!-- LSIL -->
                                                <div class="flex flex-col gap-1">
                                                    <label class="flex items-start gap-2 text-[12px] theme-text font-bold cursor-pointer hover:bg-black/5 p-1 rounded transition" :class="{'bg-amber-500/10': formReport.squamousMain==='Low grade squamous intraepithelial lesion (LSIL) encompassing', 'opacity-50 cursor-not-allowed': viewMode}">
                                                        <input type="radio" v-model="formReport.squamousMain" value="Low grade squamous intraepithelial lesion (LSIL) encompassing" class="mt-0.5 w-3.5 h-3.5 text-amber-500 focus:ring-amber-500" :disabled="viewMode"> <span>Low grade squamous intraepithelial lesion (LSIL) encompassing</span>
                                                    </label>
                                                    <div v-show="formReport.squamousMain === 'Low grade squamous intraepithelial lesion (LSIL) encompassing'" class="ml-5 pl-2 border-l-2 border-amber-200 animate-slide-up flex flex-wrap gap-2 py-1">
                                                        <label class="flex items-center gap-1.5 text-[11px] theme-text cursor-pointer bg-black/5 px-2 py-1 rounded-md border theme-border hover:bg-black/10 transition" :class="{'ring-1 ring-amber-400 bg-amber-50': formReport.squamousSubMulti.includes('221 HPV change')}"><input type="checkbox" v-model="formReport.squamousSubMulti" value="221 HPV change" class="w-3 h-3 text-amber-500 focus:ring-amber-500 rounded" :disabled="viewMode"> 221 HPV change</label>
                                                        <label class="flex items-center gap-1.5 text-[11px] theme-text cursor-pointer bg-black/5 px-2 py-1 rounded-md border theme-border hover:bg-black/10 transition" :class="{'ring-1 ring-amber-400 bg-amber-50': formReport.squamousSubMulti.includes('222 CIN I')}"><input type="checkbox" v-model="formReport.squamousSubMulti" value="222 CIN I" class="w-3 h-3 text-amber-500 focus:ring-amber-500 rounded" :disabled="viewMode"> 222 CIN I</label>
                                                        <p v-if="formReport.squamousSubMulti.length === 0 && !viewMode" class="text-[10px] text-red-500 w-full mt-0.5">* กรุณาเลือกอย่างน้อย 1 ข้อ</p>
                                                    </div>
                                                </div>

                                                <!-- HSIL -->
                                                <div class="flex flex-col gap-1">
                                                    <label class="flex items-start gap-2 text-[12px] theme-text font-bold cursor-pointer hover:bg-black/5 p-1 rounded transition" :class="{'bg-amber-500/10': formReport.squamousMain==='High grade squamous intraepithelial lesion (HSIL) encompassing', 'opacity-50 cursor-not-allowed': viewMode}">
                                                        <input type="radio" v-model="formReport.squamousMain" value="High grade squamous intraepithelial lesion (HSIL) encompassing" class="mt-0.5 w-3.5 h-3.5 text-amber-500 focus:ring-amber-500" :disabled="viewMode"> <span>High grade squamous intraepithelial lesion (HSIL) encompassing</span>
                                                    </label>
                                                    <div v-show="formReport.squamousMain === 'High grade squamous intraepithelial lesion (HSIL) encompassing'" class="ml-5 pl-2 border-l-2 border-amber-200 space-y-1 animate-slide-up">
                                                        <label class="flex items-center gap-2 text-[11px] theme-text cursor-pointer hover:bg-black/5 p-1 rounded"><input type="radio" v-model="formReport.squamousSubSingle" value="231 CIN II" :required="formReport.squamousMain === 'High grade squamous intraepithelial lesion (HSIL) encompassing'" class="w-3 h-3 text-amber-500 focus:ring-amber-500" :disabled="viewMode"> 231 CIN II</label>
                                                        <label class="flex items-center gap-2 text-[11px] theme-text cursor-pointer hover:bg-black/5 p-1 rounded"><input type="radio" v-model="formReport.squamousSubSingle" value="232 CIN III" :required="formReport.squamousMain === 'High grade squamous intraepithelial lesion (HSIL) encompassing'" class="w-3 h-3 text-amber-500 focus:ring-amber-500" :disabled="viewMode"> 232 CIN III</label>
                                                        <label class="flex items-center gap-2 text-[11px] theme-text cursor-pointer hover:bg-black/5 p-1 rounded"><input type="radio" v-model="formReport.squamousSubSingle" value="234 With features suspicious for invasion" :required="formReport.squamousMain === 'High grade squamous intraepithelial lesion (HSIL) encompassing'" class="w-3 h-3 text-amber-500 focus:ring-amber-500" :disabled="viewMode"> 234 With features suspicious for invasion</label>
                                                        <div class="flex flex-col">
                                                            <label class="flex items-center gap-2 text-[11px] theme-text cursor-pointer hover:bg-black/5 p-1 rounded"><input type="radio" v-model="formReport.squamousSubSingle" value="241 SIL" :required="formReport.squamousMain === 'High grade squamous intraepithelial lesion (HSIL) encompassing'" class="w-3 h-3 text-amber-500 focus:ring-amber-500" :disabled="viewMode"> 241 SIL</label>
                                                            <div v-show="formReport.squamousSubSingle === '241 SIL'" class="ml-5 mt-1 flex gap-2 animate-slide-up">
                                                                <select v-model="formReport.vainOption" class="input-std focus:ring-2 focus:ring-amber-500 font-bold py-1 text-[11px] bg-amber-50" :required="formReport.squamousSubSingle === '241 SIL'" :disabled="viewMode">
                                                                    <option value="" disabled selected>เลือกระดับ VAIN...</option>
                                                                    <option value="VAIN">VAIN</option><option value="VAIN I">VAIN I</option><option value="VAIN II">VAIN II</option><option value="VAIN III">VAIN III</option>
                                                                </select>
                                                            </div>
                                                        </div>
                                                        <label class="flex items-center gap-2 text-[11px] theme-text cursor-pointer hover:bg-black/5 p-1 rounded"><input type="radio" v-model="formReport.squamousSubSingle" value="251 Squamous cell carcinoma" :required="formReport.squamousMain === 'High grade squamous intraepithelial lesion (HSIL) encompassing'" class="w-3 h-3 text-amber-500 focus:ring-amber-500" :disabled="viewMode"> 251 Squamous cell carcinoma</label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- === GLANDULAR CELL === -->
                                        <div class="bg-[var(--bg-card)] border theme-border rounded-xl p-3 shadow-sm">
                                            <h4 class="text-[12px] font-bold text-amber-700 uppercase tracking-widest mb-2 border-b border-amber-500/20 pb-1">Glandular Cell</h4>
                                            
                                            <div class="space-y-1.5">
                                                <label class="flex items-start gap-2 text-[12px] theme-text font-medium cursor-pointer hover:bg-black/5 p-1 rounded transition" :class="{'opacity-50 cursor-not-allowed': viewMode}">
                                                    <input type="radio" v-model="formReport.glandularMain" value="" class="mt-0.5 w-3.5 h-3.5 text-amber-500 focus:ring-amber-500" :disabled="viewMode"> <span>(ไม่ระบุ)</span>
                                                </label>

                                                <!-- Atypical glandular cells -->
                                                <div class="flex flex-col gap-1">
                                                    <label class="flex items-start gap-2 text-[12px] theme-text font-bold cursor-pointer hover:bg-black/5 p-1 rounded transition" :class="{'bg-amber-500/10': formReport.glandularMain==='Atypical glandular cells', 'opacity-50 cursor-not-allowed': viewMode}">
                                                        <input type="radio" v-model="formReport.glandularMain" value="Atypical glandular cells" class="mt-0.5 w-3.5 h-3.5 text-amber-500 focus:ring-amber-500" :disabled="viewMode"> <span>Atypical glandular cells</span>
                                                    </label>
                                                    <div v-show="formReport.glandularMain === 'Atypical glandular cells'" class="ml-5 pl-2 border-l-2 border-amber-200 space-y-1 animate-slide-up">
                                                        <label class="flex items-center gap-2 text-[11px] theme-text cursor-pointer hover:bg-black/5 p-1 rounded"><input type="radio" v-model="formReport.glandularSub" value="261 Endocervical" :required="formReport.glandularMain === 'Atypical glandular cells'" class="w-3 h-3 text-amber-500 focus:ring-amber-500" :disabled="viewMode"> 261 Endocervical</label>
                                                        <label class="flex items-center gap-2 text-[11px] theme-text cursor-pointer hover:bg-black/5 p-1 rounded"><input type="radio" v-model="formReport.glandularSub" value="262 Endometrial" :required="formReport.glandularMain === 'Atypical glandular cells'" class="w-3 h-3 text-amber-500 focus:ring-amber-500" :disabled="viewMode"> 262 Endometrial</label>
                                                        <label class="flex items-center gap-2 text-[11px] theme-text cursor-pointer hover:bg-black/5 p-1 rounded"><input type="radio" v-model="formReport.glandularSub" value="263 NOS" :required="formReport.glandularMain === 'Atypical glandular cells'" class="w-3 h-3 text-amber-500 focus:ring-amber-500" :disabled="viewMode"> 263 NOS</label>
                                                    </div>
                                                </div>

                                                <!-- Atypical glandular cells favor neoplasia -->
                                                <div class="flex flex-col gap-1">
                                                    <label class="flex items-start gap-2 text-[12px] theme-text font-bold cursor-pointer hover:bg-black/5 p-1 rounded transition" :class="{'bg-amber-500/10': formReport.glandularMain==='Atypical glandular cells favor neoplasia', 'opacity-50 cursor-not-allowed': viewMode}">
                                                        <input type="radio" v-model="formReport.glandularMain" value="Atypical glandular cells favor neoplasia" class="mt-0.5 w-3.5 h-3.5 text-amber-500 focus:ring-amber-500" :disabled="viewMode"> <span>Atypical glandular cells favor neoplasia</span>
                                                    </label>
                                                    <div v-show="formReport.glandularMain === 'Atypical glandular cells favor neoplasia'" class="ml-5 pl-2 border-l-2 border-amber-200 space-y-1 animate-slide-up">
                                                        <label class="flex items-center gap-2 text-[11px] theme-text cursor-pointer hover:bg-black/5 p-1 rounded"><input type="radio" v-model="formReport.glandularSub" value="271 Endocervical" :required="formReport.glandularMain === 'Atypical glandular cells favor neoplasia'" class="w-3 h-3 text-amber-500 focus:ring-amber-500" :disabled="viewMode"> 271 Endocervical</label>
                                                        <label class="flex items-center gap-2 text-[11px] theme-text cursor-pointer hover:bg-black/5 p-1 rounded"><input type="radio" v-model="formReport.glandularSub" value="272 Endometrial" :required="formReport.glandularMain === 'Atypical glandular cells favor neoplasia'" class="w-3 h-3 text-amber-500 focus:ring-amber-500" :disabled="viewMode"> 272 Endometrial</label>
                                                        <label class="flex items-center gap-2 text-[11px] theme-text cursor-pointer hover:bg-black/5 p-1 rounded"><input type="radio" v-model="formReport.glandularSub" value="273 NOS" :required="formReport.glandularMain === 'Atypical glandular cells favor neoplasia'" class="w-3 h-3 text-amber-500 focus:ring-amber-500" :disabled="viewMode"> 273 NOS</label>
                                                    </div>
                                                </div>

                                                <!-- AIS -->
                                                <label class="flex items-start gap-2 text-[12px] theme-text font-bold cursor-pointer hover:bg-black/5 p-1 rounded transition" :class="{'bg-amber-500/10': formReport.glandularMain==='281 Endocervical adenocarcinoma in situ (AIS)', 'opacity-50 cursor-not-allowed': viewMode}">
                                                    <input type="radio" v-model="formReport.glandularMain" value="281 Endocervical adenocarcinoma in situ (AIS)" class="mt-0.5 w-3.5 h-3.5 text-amber-500 focus:ring-amber-500" :disabled="viewMode"> <span>281 Endocervical adenocarcinoma in situ (AIS)</span>
                                                </label>

                                                <!-- Adenocarcinoma -->
                                                <div class="flex flex-col gap-1">
                                                    <label class="flex items-start gap-2 text-[12px] theme-text font-bold cursor-pointer hover:bg-black/5 p-1 rounded transition" :class="{'bg-amber-500/10': formReport.glandularMain==='Adenocarcinoma', 'opacity-50 cursor-not-allowed': viewMode}">
                                                        <input type="radio" v-model="formReport.glandularMain" value="Adenocarcinoma" class="mt-0.5 w-3.5 h-3.5 text-amber-500 focus:ring-amber-500" :disabled="viewMode"> <span>Adenocarcinoma</span>
                                                    </label>
                                                    <div v-show="formReport.glandularMain === 'Adenocarcinoma'" class="ml-5 pl-2 border-l-2 border-amber-200 space-y-1 animate-slide-up">
                                                        <label class="flex items-center gap-2 text-[11px] theme-text cursor-pointer hover:bg-black/5 p-1 rounded"><input type="radio" v-model="formReport.glandularSub" value="291 Endocervical" :required="formReport.glandularMain === 'Adenocarcinoma'" class="w-3 h-3 text-amber-500 focus:ring-amber-500" :disabled="viewMode"> 291 Endocervical</label>
                                                        <label class="flex items-center gap-2 text-[11px] theme-text cursor-pointer hover:bg-black/5 p-1 rounded"><input type="radio" v-model="formReport.glandularSub" value="292 Endometrial" :required="formReport.glandularMain === 'Adenocarcinoma'" class="w-3 h-3 text-amber-500 focus:ring-amber-500" :disabled="viewMode"> 292 Endometrial</label>
                                                        <label class="flex items-center gap-2 text-[11px] theme-text cursor-pointer hover:bg-black/5 p-1 rounded"><input type="radio" v-model="formReport.glandularSub" value="293 Not otherwise specified (NOS)" :required="formReport.glandularMain === 'Adenocarcinoma'" class="w-3 h-3 text-amber-500 focus:ring-amber-500" :disabled="viewMode"> 293 Not otherwise specified (NOS)</label>
                                                    </div>
                                                </div>

                                            </div>
                                        </div>

                                    </div>
                                </div>
                                
                                <!-- 300 OTHER MALIGNANT & Comment -->
                                <div class="p-3 md:p-4 border-b theme-border bg-rose-500/5">
                                    <h3 class="font-black text-rose-600 mb-2 text-[14px] border-l-[3px] border-rose-500 pl-2">300 OTHER MALIGNANT NEOPLASMS</h3>
                                    <input v-model="formReport.cat300" type="text" class="input-std focus:ring-2 focus:ring-rose-500 font-bold text-[13px] py-1.5" placeholder="พิมพ์คำอธิบาย (ถ้ามี)..." :disabled="viewMode">
                                    
                                    <div class="pt-3 mt-1 border-t border-rose-500/10">
                                        <label class="label-sm text-slate-600 flex items-center gap-1.5"><i class="ph ph-chat-text text-base"></i> Comment</label>
                                        <textarea v-model="formReport.comment" rows="2" class="input-std focus:ring-2 focus:ring-slate-500 font-medium resize-none text-[13px] py-1.5" placeholder="อธิบายข้อมูลเพิ่มเติม..." :disabled="viewMode"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ================= SIGNATURES (Full Width Bottom) ================= -->
                        <div class="p-3 md:p-4 bg-black/5">
                            <h3 class="font-black theme-text mb-3 text-[14px] border-l-[3px] border-slate-400 pl-2">Signatures</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                
                                <div class="bg-indigo-500/10 p-3 rounded-xl border border-indigo-500/20 shadow-sm relative overflow-hidden">
                                    <div class="absolute -right-4 -top-4 w-20 h-20 bg-indigo-500/10 rounded-full blur-xl"></div>
                                    <h4 class="font-black text-indigo-600 mb-2 flex items-center gap-1.5 relative z-10 text-[13px]"><i class="ph ph-microscope text-base"></i> Cytotechnologist</h4>
                                    <div class="space-y-2 relative z-10">
                                        <div>
                                            <select v-model="formReport.cytoName" class="input-std focus:ring-2 focus:ring-indigo-400 font-bold text-[12px] py-1.5" required :disabled="viewMode">
                                                <option value="" disabled selected>เลือกผู้รายงาน...</option>
                                                <option v-for="(name, idx) in masterCytoTechs" :key="'cy-'+idx" :value="name">{{ name }}</option>
                                            </select>
                                        </div>
                                        <div class="grid grid-cols-2 gap-2.5">
                                            <div><input type="date" v-model="formReport.cytoDate" class="input-std focus:ring-2 focus:ring-indigo-400 font-bold text-[12px] py-1.5" required :disabled="viewMode"></div>
                                            <div><input type="time" v-model="formReport.cytoTime" class="input-std focus:ring-2 focus:ring-indigo-400 font-bold text-[12px] py-1.5" required :disabled="viewMode"></div>
                                        </div>
                                    </div>
                                </div>

                                <div class="bg-rose-500/5 p-3 rounded-xl border transition-colors shadow-sm relative overflow-hidden" :class="formReport.hasPatho ? 'border-rose-500/30 bg-rose-500/10' : 'theme-border'">
                                    <div class="absolute -right-4 -top-4 w-20 h-20 bg-rose-500/10 rounded-full blur-xl"></div>
                                    <label class="flex items-center gap-2 mb-2 relative z-10" :class="viewMode ? 'cursor-not-allowed' : 'cursor-pointer'">
                                        <input type="checkbox" v-model="formReport.hasPatho" class="w-3.5 h-3.5 text-rose-500 focus:ring-rose-500 rounded border-slate-300" :disabled="viewMode">
                                        <h4 class="font-black flex items-center gap-1.5 text-[13px]" :class="formReport.hasPatho ? 'text-rose-600' : 'theme-text-muted'"><i class="ph ph-stethoscope text-base"></i> Pathologist</h4>
                                    </label>
                                    
                                    <div v-show="formReport.hasPatho" class="space-y-2 animate-slide-up relative z-10">
                                        <div>
                                            <select v-model="formReport.pathoName" class="input-std focus:ring-2 focus:ring-rose-400 font-bold text-[12px] py-1.5" :required="formReport.hasPatho" :disabled="viewMode">
                                                <option value="" disabled selected>เลือกพยาธิแพทย์...</option>
                                                <option v-for="(name, idx) in masterPathos" :key="'pa-'+idx" :value="name">{{ name }}</option>
                                            </select>
                                        </div>
                                        <div class="grid grid-cols-2 gap-2.5">
                                            <div><input type="date" v-model="formReport.pathoDate" class="input-std focus:ring-2 focus:ring-rose-400 font-bold text-[12px] py-1.5" :required="formReport.hasPatho" :disabled="viewMode"></div>
                                            <div><input type="time" v-model="formReport.pathoTime" class="input-std focus:ring-2 focus:ring-rose-400 font-bold text-[12px] py-1.5" :required="formReport.hasPatho" :disabled="viewMode"></div>
                                        </div>
                                    </div>
                                    <div v-show="!formReport.hasPatho && !viewMode" class="text-[10px] theme-text-muted font-medium italic relative z-10">ติ๊กเลือกเพื่อระบุชื่อพยาธิแพทย์</div>
                                </div>
                            </div>
                        </div>

                        <div v-if="!viewMode" class="bg-[var(--bg-card)] p-3 md:p-4 flex flex-col md:flex-row justify-end gap-3 border-t theme-border">
                            <button type="button" @click="page='report_list'" class="px-6 py-2 rounded-xl theme-text-muted hover:theme-text hover:bg-black/5 transition font-bold text-[13px]">ยกเลิก</button>
                            <button type="submit" class="px-8 py-2 rounded-xl bg-gradient-to-r from-emerald-500 to-teal-500 text-white font-black shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-0.5 text-[13px]">{{ formReport.patient.status === 'Reported' ? 'บันทึกแก้ไขผลรายงาน' : 'บันทึกผลรายงาน' }}</button>
                        </div>
                    </form>
                </div>
                </transition>
            </div>
        </main>
    </div>
  </div>
  <?!= include('js'); ?>
</body>
</html>
